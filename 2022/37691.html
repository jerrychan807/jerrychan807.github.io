<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jerrychan807.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言: 找了一个旧版本的cosmos-sdk教程,目标是构建一个域名解析应用. 类似于Namecoin，ENS，Handshake这些模仿传统的DNS系统（map[domain]zonefile）的应用。用户可以购买未被使用的域名，或是出售&#x2F;交易这些域名。 参考网址如下:   cosmos官方nameservice测试项目详解（代码注释+官方文档错误纠正）   Cosmos SDK 中文文档">
<meta property="og:type" content="article">
<meta property="og:title" content="StudyRecord-Cosmos官方NameService域名解析应用教程">
<meta property="og:url" content="https://jerrychan807.github.io/2022/37691.html">
<meta property="og:site_name" content="Trash Bin">
<meta property="og:description" content="前言: 找了一个旧版本的cosmos-sdk教程,目标是构建一个域名解析应用. 类似于Namecoin，ENS，Handshake这些模仿传统的DNS系统（map[domain]zonefile）的应用。用户可以购买未被使用的域名，或是出售&#x2F;交易这些域名。 参考网址如下:   cosmos官方nameservice测试项目详解（代码注释+官方文档错误纠正）   Cosmos SDK 中文文档">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907161249.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907160412.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907181345.png">
<meta property="og:image" content="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220908145241.png">
<meta property="article:published_time" content="2022-09-07T04:00:34.000Z">
<meta property="article:modified_time" content="2024-04-18T16:53:54.177Z">
<meta property="article:author" content="Foolisheddy">
<meta property="article:tag" content="StudyRecord">
<meta property="article:tag" content="BlockChain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907161249.png">

<link rel="canonical" href="https://jerrychan807.github.io/2022/37691.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>StudyRecord-Cosmos官方NameService域名解析应用教程 | Trash Bin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Trash Bin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jerrychan807.github.io/2022/37691.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2019/04/26/5cc1da1c90e1a.png">
      <meta itemprop="name" content="Foolisheddy">
      <meta itemprop="description" content="温故而知新">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Trash Bin">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          StudyRecord-Cosmos官方NameService域名解析应用教程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-07 12:00:34" itemprop="dateCreated datePublished" datetime="2022-09-07T12:00:34+08:00">2022-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-19 00:53:54" itemprop="dateModified" datetime="2024-04-19T00:53:54+08:00">2024-04-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/StudyRecord/" itemprop="url" rel="index"><span itemprop="name">StudyRecord</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>50 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1>前言:</h1>
<p>找了一个旧版本的<code>cosmos-sdk</code>教程,目标是构建一个域名解析应用. 类似于Namecoin，ENS，Handshake这些模仿传统的DNS系统（<code>map[domain]zonefile</code>）的应用。用户可以购买未被使用的域名，或是出售/交易这些域名。</p>
<p>参考网址如下:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43988498/article/details/114996094">cosmos官方nameservice测试项目详解（代码注释+官方文档错误纠正）</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/cosmos/tutorial/06-set-name.html#msg">Cosmos SDK 中文文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/547fc70b8335">cosmos-sdk-tutorials namechain 体验过程解析</a></p>
</li>
</ul>
<p>完整项目源码: <code>https://github.com/jerrychan807/cosmos-nameservice</code></p>
<h1>开发环境配置:</h1>
<h2 id="使用旧版的go">使用旧版的go:</h2>
<p>一开始使用1.18版本的go,在后面会报该错误<a target="_blank" rel="noopener" href="https://github.com/cosmos/gravity-bridge/issues/320">panic: crypto/hmac: hash generation function does not produce unique values when using ebdcli keys to add account</a>,所以选择降级到<code>1.15.15</code>版本的go,就不会出现该错误了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget https://golang.google.cn/dl/go1.15.15.linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf go1.15.15.linux-amd64.tar.gz -C /usr/</span><br><span class="line"><span class="comment"># 修改环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GOROOT</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> GOPATH=/opt/go15</span><br><span class="line"><span class="built_in">export</span> PATH=$(go <span class="built_in">env</span> GOPATH)/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<p>通过修改环境变量的顺序,使得先读取到<code>1.15.15</code>版本的go</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># echo $PATH</span></span><br><span class="line">/opt/go15/bin:/usr/go/bin:/usr/go/bin:/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/local/go/bin:/opt/go/BIN:/opt/go/bin/:/opt/go/bin:/root/bin:/usr/go/bin:/opt/go15/bin:/usr/go/bin:/opt/go15/bin</span><br></pre></td></tr></table></figure>
<p>1.18版本go的环境变量,记录一下,方便后面恢复:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOROOT=/usr/local/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin</span><br><span class="line"><span class="built_in">export</span> GOPATH=/opt/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOPATH</span>/BIN</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/go/bin/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:$(go <span class="built_in">env</span> GOPATH)/bin</span><br></pre></td></tr></table></figure>
<h2 id="源码构建starport">源码构建starport:</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/ignite/cli/blob/v0.13.1/docs/1%20Introduction/2%20Install.md">starport v0.13.1官方安装readme</a></p>
<h3 id="下载源码">下载源码:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载starport V0.13.1源码</span></span><br><span class="line">git <span class="built_in">clone</span> -b v0.13.1 https://github.com/ignite/cli.git</span><br><span class="line"><span class="built_in">cd</span> cli</span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>报错,提示缺少<code>packr2</code>命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh: packr2: <span class="built_in">command</span> not found</span><br><span class="line">make: *** [build] Error 127</span><br></pre></td></tr></table></figure>
<h3 id="下载packr">下载packr:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget https://github.com/gobuffalo/packr/releases/download/v2.8.1/packr_2.8.1_linux_amd64.tar.gz</span><br><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -xf packr_2.8.1_linux_amd64.tar.gz</span><br><span class="line"><span class="comment"># 移动可执行文件</span></span><br><span class="line"><span class="built_in">mv</span> packr2 /usr/bin/packr2</span><br></pre></td></tr></table></figure>
<h3 id="再次编译">再次编译:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 再次编译构建starport</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># 生成在build目录下</span></span><br><span class="line">[root@localhost build]<span class="comment"># pwd</span></span><br><span class="line">/blockchain/cli/build</span><br><span class="line"><span class="comment"># 确认版本</span></span><br><span class="line">[root@localhost build]<span class="comment"># ./starport version</span></span><br><span class="line">starport version v0.13.1 linux/amd64 -build <span class="built_in">date</span>: 2022-09-05T03:20:04</span><br><span class="line">git object <span class="built_in">hash</span>: b4e95f455cb9dfb35fcd9981786eb935cf9711c5</span><br><span class="line"><span class="comment"># 创建软连接</span></span><br><span class="line"><span class="built_in">ln</span> -s /blockchain/cli/build/starport /usr/bin/starport</span><br></pre></td></tr></table></figure>
<h1>程序目标:</h1>
<p>你正在构建的应用程序的目标是让用户购买域名并为其设置解析的值,给定域名的所有者将是当前最高出价者。</p>
<p>区块链应用程序只是一个<code>具有确定性的复制状态机</code>.<br />
状态机是一个计算机科学概念，其中一台机器可以有多个状态，但一次只能有一个状态。<br />
它遵循状态转换过程（或一组定义的过程），这是状态从旧状态或<code>初始状态 ( S) </code>更改为<code>新状态 ( S')</code>的唯一方式。<br />
<img src="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907161249.png" alt="20220907161249" /><br />
作为开发人员，你只需定义<code>状态机（即状态，启动状态和触发状态转变的消息）</code>，<code>Tendermint</code> 将为你处理通过网络进行复制。</p>
<blockquote>
<p><code>Tendermint</code>是一个与应用程序无关的引擎，负责处理区块链的<code>网络层</code>和<code>共识层</code>。实际上，这意味着<code>Tendermint</code>负责传播和排序交易字节。<code>Tendermint Core</code>依赖于拜占庭容错（BFT）算法来达成交易顺序的共识</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907160412.png" alt="20220907160412" /><br />
<code>Cosmos SDK</code>旨在帮助你构建状态机,构建应用层。<br />
SDK是一个<code>模块化框架</code>，意味着<code>应用程序</code>是通过将一组<code>可互操作的模块</code>集成在一起构建而成的。每个模块都包含自己的<code>消息/交易处理器</code>，而SDK负责将每条消息<code>路由</code>到其对应模块。</p>
<p>以下是nameservice应用程序所需的模块：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>auth</code> : 此模块定义了账户和手续费，并为你应用程序的其余部分提供了访问这些功能的权限。</p>
</li>
<li class="lvl-2">
<p><code>bank</code> : 此模块使得应用程序能够创建和管理token及余额。</p>
</li>
<li class="lvl-2">
<p><code>nameservice</code> : 需要我们自己写的nameservice应用的核心逻辑。</p>
</li>
</ul>
<p>现在，看一下应用程序的两个主要部分：<code>state（状态）</code> 和 <code>message（消息）</code>类型。</p>
<h2 id="State">State:</h2>
<p><code>state</code>反映了特定时刻你的应用程序。它告诉了每个帐户拥有多少token，每个域名的所有者和价格，以及每个域名的解析值。</p>
<p>token 和帐户的 state 由<code>auth</code>和<code>bank</code>模块定义，这意味着你现在不必关心它。你需要做的是定义与你的<code>nameservice</code>模块特定相关部分state。<br />
在 SDK 中，所有内容都存储在一个名为<code>multistore</code>的存储中。可以在此<code>multistore</code>中创建任意数量的键值对存储（在Cosmos SDK中称<code>作KVStore</code>）。<br />
在本应用中，我们将使用一个 store 记录 <code>name</code> 与 <code>whois</code> 信息，name 的 <code>value</code>、<code>owner</code> 和 <code>price</code> 将存储在一个结构中。</p>
<h2 id="Message">Message:</h2>
<p><code>message</code> 包含在 <code>transaction</code> 中。它们负责<code>触发state的转变</code>。<br />
每个模块定义了一个<code>message</code>列表及如何去处理它们。</p>
<p>下面这些 <code>message</code> 是你需要为你的 <code>nameservice</code> 应用去实现的：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>MsgSetName</code>: 此 message 允许域名的所有者为指定域名的<code>nameStore</code>设置一个值。</p>
</li>
<li class="lvl-2">
<p><code>MsgBuyName</code>: 此 message 允许账户去购买一个域名并在<code>ownerStore</code>中成为所有者。</p>
<ul class="lvl-2">
<li class="lvl-4">当有人购买一个域名时，他们需要支付比之前所有者购买价格更高的费用。</li>
<li class="lvl-4">如果域名还没有人购买，那么他们需要燃烧最小价格（MinPrice）的代币。</li>
</ul>
</li>
</ul>
<h2 id="交易的处理流程">交易的处理流程:</h2>
<ul class="lvl-0">
<li class="lvl-2">
<p>当一条<code>交易</code>（包含在区块中）到达一个<code>Tendermint</code>节点时，它将通过 <code>ABCI</code> 传递给应用程序并被解码以得到 <code>message</code>。</p>
</li>
<li class="lvl-2">
<p>然后将<code>message</code>路由至对应的<code>模块module</code>，并根据定义在<code>Handler</code>中的逻辑来进行处理。</p>
</li>
<li class="lvl-2">
<p>如果 <code>state</code> 需要更新，<code>Handler</code>会调用<code>Keeper</code>来执行更新。</p>
</li>
</ul>
<h1>开始编写你的程序:</h1>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成脚手架</span></span><br><span class="line">starport app github.com/jerrychan807/cosmos-nameservice --sdk-version=<span class="string">&quot;launchpad&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">starport app github.com/jerrychan807/cosmos-nameservice --sdk-version=<span class="string">&quot;launchpad&quot;</span></span><br><span class="line"></span><br><span class="line">⭐️ Successfully created a Cosmos app <span class="string">&#x27;cosmos-nameservice&#x27;</span>.</span><br><span class="line">👉 Get started with the following commands:</span><br><span class="line"></span><br><span class="line"> % <span class="built_in">cd</span> cosmos-nameservice</span><br><span class="line"> % starport serve</span><br><span class="line"></span><br><span class="line">NOTE: add --verbose flag <span class="keyword">for</span> verbose (detailed) output.</span><br></pre></td></tr></table></figure>
<p>其中<code>app.go</code>,这个文件是<code>确定性状态机</code>的核心。</p>
<p>在<code>app.go</code>中，你定义了<strong>应用程序在接收交易时执行的操作</strong>。<br />
但首先，它要能够以正确的顺序接收交易。这是 <code>Tendermint共识引擎</code>的职责。<br />
<code>Tendermint</code> 通过名为 <code>ABCI</code> 的接口将交易从网络传递给应用程序。<br />
<img src="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220907181345.png" alt="20220907181345" /><br />
幸运的是，你不必实现ABCI接口。<code>Cosmos SDK</code>以<code>baseapp</code>的形式提供了区块链应用的雏形,我们只要基于<code>baseapp</code>定制化进行开发即可。<br />
baseapp做了以下几点：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>解码从 <code>Tendermint共识引擎</code>接收到的<code>交易</code>。</p>
</li>
<li class="lvl-2">
<p>从交易中提取 <code>messages</code> 并做基本的合理性校验。</p>
</li>
<li class="lvl-2">
<p>将这些 message <code>路由</code>到合适的模块使其被正确处理。</p>
</li>
<li class="lvl-2">
<p>如果 ABCI 消息是<code>DeliverTx（CheckTx）</code>的话就<code>Commit</code>。</p>
</li>
<li class="lvl-2">
<p>帮助设置<code>BeginBlock</code>和<code>EndBlock</code>,这两种消息让你能定义在每个区块开始和结束时执行的逻辑。</p>
</li>
<li class="lvl-2">
<p>帮助初始化你的 <code>state</code>。</p>
</li>
<li class="lvl-2">
<p>帮助设置 <code>queries</code>。</p>
</li>
</ul>
<p><code>baseapp</code>不能够识别用户自定义模块的路由和应用程序中自定义的用户接口,我们需要将我们的<code>cosmosnameservicetypes</code>类型将嵌入到<code>baseapp</code>中。</p>
<blockquote>
<p>需要修改 <a target="_blank" rel="noopener" href="https://github.com/jerrychan807/cosmos-nameservice/blob/main/app/app.go">app.go</a></p>
</blockquote>
<blockquote>
<p>为了完成应用程序,你需要引入一些模块.继续开始构建你的域名服务模块.稍后会回到<code>app.go</code>.</p>
</blockquote>
<h1>类型Types:</h1>
<p>我们要做的第一件事是定义一个结构，包含域名所有元数据。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># starport创建whois类型</span></span><br><span class="line">starport <span class="built_in">type</span> whois value price</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># starport type whois value price</span></span><br><span class="line"></span><br><span class="line">🎉 Created a <span class="built_in">type</span> `whois`.</span><br></pre></td></tr></table></figure>
<p>每个域名有以下相关的数据：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>Value</code>: 域名解析出为的值</p>
</li>
<li class="lvl-2">
<p><code>Creator</code>: 该域名当前所有者的地址</p>
</li>
<li class="lvl-2">
<p><code>Price</code>: 你需要为购买域名支付的费用</p>
</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Whois <span class="keyword">struct</span> &#123;</span><br><span class="line">	Creator sdk.AccAddress <span class="string">`json:&quot;creator&quot; yaml:&quot;creator&quot;`</span></span><br><span class="line">	ID      <span class="type">string</span>         <span class="string">`json:&quot;id&quot; yaml:&quot;id&quot;`</span></span><br><span class="line">	Value   <span class="type">string</span>         <span class="string">`json:&quot;value&quot; yaml:&quot;value&quot;`</span></span><br><span class="line">	Price   sdk.Coins      <span class="string">`json:&quot;price&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/types/TypeWhois.go</code></p>
</blockquote>
<h1>Keeper:</h1>
<p><code>Cosmos SDK</code>模块的主要核心是名为<code>Keeper</code>的部分。<br />
它处理<code>存储的交互</code>，引用其他的keeper进行<code>跨模块的交互</code>，并包含模块的大部分核心功能。</p>
<h2 id="Keeper结构">Keeper结构:</h2>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> keeper</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/tendermint/tendermint/libs/log&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/x/bank&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Keeper of the cosmosnameservice store</span></span><br><span class="line"><span class="comment">// Keeper结构体</span></span><br><span class="line"><span class="keyword">type</span> Keeper <span class="keyword">struct</span> &#123;</span><br><span class="line">	CoinKeeper bank.Keeper  <span class="comment">// bank模块, 底层管理token的模块</span></span><br><span class="line">	storeKey   sdk.StoreKey <span class="comment">// cosmos-sdk/types的通用存储key类型</span></span><br><span class="line">	cdc        *codec.Codec <span class="comment">// 底层编码模块</span></span><br><span class="line">	<span class="comment">// paramspace types.ParamSubspace</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要修改<a target="_blank" rel="noopener" href="https://github.com/jerrychan807/cosmos-nameservice/blob/main/x/cosmosnameservice/keeper/keeper.go">x/cosmosnameservice/keeper/keeper.go</a></p>
</blockquote>
<p>关于上述代码的几点说明：</p>
<p>3个不同的<code>cosmos-sdk</code>包被引入：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>codec</code>: 提供负责Cosmos编码格式的工具——Amino。</p>
</li>
<li class="lvl-2">
<p><code>bank</code>: 控制账户和转账。</p>
</li>
<li class="lvl-2">
<p><code>types</code>: 包含了整个SDK常用的类型。</p>
</li>
</ul>
<p>Keeper结构体。在 keeper 中有几个关键部分：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>bank.Keeper</code>: 这是bank模块的Keeper引用。包括它来允许该模块中的代码调用bank模块的函数。</p>
<ul class="lvl-2">
<li class="lvl-6">SDK使用<code>对象能力</code>来访问应用程序状态的各个部分。这是为了允许开发人员采用小权限准入原则，限制错误或恶意模块的去影响其不需要访问的状态的能力。</li>
</ul>
</li>
<li class="lvl-2">
<p><code>*codec.Codec</code>: 这是被<code>Amino</code>用于编码及解码的指针。</p>
</li>
<li class="lvl-2">
<p><code>sdk.StoreKey</code>: 通过它来访问一个持久化保存你的应用程序状态的<code>sdk.KVStore</code>。</p>
</li>
</ul>
<p>模块有1个StoreKey:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>storeKey</code>: 这是 name 指向（如 <code>map[name]Whois</code>）Whois 结构的主存储空间</p>
</li>
</ul>
<h2 id="Getter-和-Setter">Getter 和 Setter:</h2>
<p>现在要添加通过<code>Keeper</code>来与存储交互的方法了。<br />
首先，添加一个函数来为指定域名设置解析字符串值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetWhois sets a whois. We modified this function to use the `name` value as the key instead of msg.ID</span></span><br><span class="line"><span class="comment">// 存储Whois,我们修改这个函数,使用&#x27;name&#x27;值作为键,而不是msg.ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> SetWhois(ctx sdk.Context, name <span class="type">string</span>, whois types.Whois) &#123;</span><br><span class="line">	store := ctx.KVStore(k.storeKey)</span><br><span class="line">	<span class="comment">// 使用cdc编码参数whois结构体返回的bz是byte切片</span></span><br><span class="line">	<span class="comment">// MustMarshalBinaryLengthPrefixed 有Must代表不返回其错误直接Panic处理,即使有err的话，没有的话返回可能的错误</span></span><br><span class="line">	bz := k.cdc.MustMarshalBinaryLengthPrefixed(whois)</span><br><span class="line">	<span class="comment">// 使用&#x27;name&#x27;值作为键,而不是msg.ID</span></span><br><span class="line">	key := []<span class="type">byte</span>(types.WhoisPrefix + name)</span><br><span class="line">	<span class="comment">// 存储</span></span><br><span class="line">	store.Set(key, bz)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查找域名对应的解析值函数:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetWhois returns the whois information</span></span><br><span class="line"><span class="comment">// 获取whois结构体数据, key就是域名的name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetWhois(ctx sdk.Context, key <span class="type">string</span>) (types.Whois, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 1. 使用StoreKey访问存储,获取namservice数据库</span></span><br><span class="line">	store := ctx.KVStore(k.storeKey)</span><br><span class="line">	<span class="keyword">var</span> whois types.Whois</span><br><span class="line">	<span class="comment">// 2. 拼接key, whois前缀 + 获取参数key</span></span><br><span class="line">	byteKey := []<span class="type">byte</span>(types.WhoisPrefix + key)</span><br><span class="line">	<span class="comment">// 3. 使用keeper的codec类型cdc解码, 赋值给whois结构体</span></span><br><span class="line">	err := k.cdc.UnmarshalBinaryLengthPrefixed(store.Get(byteKey), &amp;whois)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> whois, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 4. 返回</span></span><br><span class="line">	<span class="keyword">return</span> whois, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/keeper/whois.go</code></p>
</blockquote>
<h2 id="其他函数">其他函数:</h2>
<p>继续添加其他函数:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取whois的所有数量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetWhoisCount()</span><br><span class="line"><span class="comment">// 存储whois的总数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> SetWhoisCount()</span><br><span class="line"><span class="comment">// 删除一个whois结构体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> DeleteWhois()</span><br><span class="line"><span class="comment">// 获取域名的创建者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetCreator()</span><br><span class="line"><span class="comment">// 检查当前域名key/name是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> Exists()</span><br><span class="line"><span class="comment">// 获取域名的解析值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> ResolveName()</span><br><span class="line"><span class="comment">// 设置域名对应的解析值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> SetName()</span><br><span class="line"><span class="comment">// 检查当前域名是否有创建人</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> HasCreator()</span><br><span class="line"><span class="comment">// 设置域名的当前拥有者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> SetCreator()</span><br><span class="line"><span class="comment">// 获取域名的价格</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetPrice()</span><br><span class="line"><span class="comment">// 设置域名的价格</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> SetPrice()</span><br><span class="line"><span class="comment">// 检查当前的name参数是否存在于store中，注意于Exists函数的区别：没有加前缀</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> IsNamePresent()</span><br><span class="line"><span class="comment">// 获取固定前缀的迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetNamesIterator()</span><br><span class="line"><span class="comment">// 根据key = id获取whois的创建者， 但是可能会返回err</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> GetWhoisOwner()</span><br><span class="line"><span class="comment">// 根绝key查询是否存在， key是域名结构体中的id</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k Keeper)</span></span> WhoisExists()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来,该描述如何让用户通过<code>Msgs</code>和<code>Handlers</code>与刚刚建立的<code>store</code>交互。</p>
</blockquote>
<h1>Msg 和 Handler:</h1>
<p>现在你已经设置了<code>Keeper</code>，是时候构建允许用户购买域名和设置解析值的<code>Msg</code>和<code>Handler</code>了。</p>
<h2 id="Msg">Msg:</h2>
<p><code>Msg</code>触发状态转变。<code>Msgs</code>被包裹在客户端提交至网络的<code>Txs</code>中。<br />
Cosmos SDK从<code>Txs</code>中打包和解包<code>Msgs</code>，这就意味着，作为一个应用开发者，你只需要去定义<code>Msgs</code>。<br />
Msg必须要满足以下接口:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transactions messages must fulfill the Msg</span></span><br><span class="line"><span class="comment">// 实现接口必须实现所有的函数</span></span><br><span class="line"><span class="keyword">type</span> Msg <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Return the message type.</span></span><br><span class="line">	<span class="comment">// Must be alphanumeric or empty.</span></span><br><span class="line">	<span class="comment">// 返回消息类型， 必须是字母或者空</span></span><br><span class="line">	Type() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns a human-readable string for the message, intended for utilization</span></span><br><span class="line">	<span class="comment">// within tags</span></span><br><span class="line">	<span class="comment">// 返回消息的可读string,用于在标签中使用</span></span><br><span class="line">	Route() <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ValidateBasic does a simple validation check that</span></span><br><span class="line">	<span class="comment">// doesn&#x27;t require access to any other information.</span></span><br><span class="line">	<span class="comment">// 做一些基本的验证, 不需要访问其他信息</span></span><br><span class="line">	ValidateBasic() <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the canonical byte representation of the Msg.</span></span><br><span class="line">	<span class="comment">// 获取Msg的规范字节表示即字节数组</span></span><br><span class="line">	GetSignBytes() []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Signers returns the addrs of signers that must sign.</span></span><br><span class="line">	<span class="comment">// CONTRACT: All signatures must be present to be valid.</span></span><br><span class="line">	<span class="comment">// CONTRACT: Returns addrs in some deterministic order.</span></span><br><span class="line">	<span class="comment">// 返回必须签名的签名者地址集合， 所有的签名必须在当下还有效， 返回的签名集合会以某种确定的顺序</span></span><br><span class="line">	GetSigners() []sdk.AccAddress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要修改<code>./x/cosmosnameservice/types/msg.go</code></p>
</blockquote>
<h2 id="Handler">Handler:</h2>
<p><code>Handler</code>定义了在接收到一个特定<code>Msg</code>时，需要采取的操作（哪些存储需要更新，怎样更新及要满足什么条件），可看作为<code>controller</code>。<br />
在此模块中，你有两种类型的<code>Msg</code>，用户可以发送这些<code>Msg</code>来和应用程序状态进行交互：<code>SetName</code>和<code>BuyName</code>。它们各自同其<code>Handler</code>关联。</p>
<blockquote>
<p>现在你已经更好地理解了 <code>Msgs</code>和<code>Handler</code>，可以开始构建你的第一条消息：<code>SetName</code>。</p>
</blockquote>
<h1>MsgSetName:</h1>
<p>SDK中Msg的命令约束是 <code>Msg&#123;.Action&#125;</code>。要实现的第一个操作是<code>SetName</code>，因此命名为<code>MsgSetName</code>。<br />
首先实现<code>SetName</code>, 这个消息Msg允许域名的所有者在解析器中设置该域名的返回值。</p>
<blockquote>
<p>需要修改<code>./x/cosmosnameservice/types/MsgSetName.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// MsgSetName defines a SetName message</span></span><br><span class="line"><span class="comment">// 定义MsgSetName的结构</span></span><br><span class="line"><span class="keyword">type</span> MsgSetName <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="type">string</span>         <span class="string">`json:&quot;name&quot;`</span>  <span class="comment">// 目标域名</span></span><br><span class="line">	Value <span class="type">string</span>         <span class="string">`json:&quot;value&quot;`</span> <span class="comment">// 对应的值/解析值</span></span><br><span class="line">	Owner sdk.AccAddress <span class="string">`json:&quot;owner&quot;`</span> <span class="comment">// 拥有者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewMsgSetName is a constructor function for MsgSetName</span></span><br><span class="line"><span class="comment">// MsgSetName构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMsgSetName</span><span class="params">(name <span class="type">string</span>, value <span class="type">string</span>, owner sdk.AccAddress)</span></span> MsgSetName &#123;</span><br><span class="line">	<span class="keyword">return</span> MsgSetName&#123;</span><br><span class="line">		Name:  name,</span><br><span class="line">		Value: value,</span><br><span class="line">		Owner: owner,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MsgSetName具有设置域名解析值所需的三个属性：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>name</code>: 所要设置的域名</p>
</li>
<li class="lvl-2">
<p><code>value</code>: 要设置的域名解析值</p>
</li>
<li class="lvl-2">
<p><code>owner</code>: 域名的所有者</p>
</li>
</ul>
<p>接下来，实现<code>Msg</code>接口：</p>
<h2 id="Route和Type接口">Route和Type接口:</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Route should return the name of the module</span></span><br><span class="line"><span class="comment">// 返回路由消息的键， 这里就是模块名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgSetName)</span></span> Route() <span class="type">string</span> &#123; <span class="keyword">return</span> RouterKey &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Type should return the action</span></span><br><span class="line"><span class="comment">// 操作名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgSetName)</span></span> Type() <span class="type">string</span> &#123; <span class="keyword">return</span> <span class="string">&quot;set_name&quot;</span> &#125;</span><br></pre></td></tr></table></figure>
<p>SDK使用上述函数将Msg路由至合适的模块进行处理。它们还为用于索引的数据库标签添加了可读性的名称。</p>
<h2 id="ValidateBasic接口">ValidateBasic接口:</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ValidateBasic runs stateless checks on the message</span></span><br><span class="line"><span class="comment">// 基本参数检测</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgSetName)</span></span> ValidateBasic() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> msg.Owner.Empty() &#123;</span><br><span class="line">		<span class="keyword">return</span> sdkerrors.Wrap(sdkerrors.ErrInvalidAddress, msg.Owner.String())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(msg.Name) == <span class="number">0</span> || <span class="built_in">len</span>(msg.Value) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, <span class="string">&quot;Name and/or Value cannot be empty&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ValidateBasic</code>用于对<code>Msg</code>的<strong>有效性进行一些基本的无状态检查</strong>。<br />
在此情形下，请检查没有属性为空。<br />
请注意这里使用<code>sdk.Error</code>类型,SDK提供了一组应用开发人员经常遇到的错误类型。</p>
<h2 id="GetSignBytes接口">GetSignBytes接口:</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetSignBytes encodes the message for signing</span></span><br><span class="line"><span class="comment">// GetSignBytes对整个MsgSetName消息本身进行编码、排序以进行后续的签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgSetName)</span></span> GetSignBytes() []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="comment">// MustMarshalJSON序列化msg为字节切片</span></span><br><span class="line">	<span class="comment">// MustSortJSON返回根据key排序的json</span></span><br><span class="line">	<span class="keyword">return</span> sdk.MustSortJSON(ModuleCdc.MustMarshalJSON(msg))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GetSignBytes</code>定义了如何编码Msg以进行签名。<br />
在大多数情形下，要编码成排好序的JSON。不应修改输出。</p>
<h2 id="GetSigners接口">GetSigners接口:</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetSigners defines whose signature is required</span></span><br><span class="line"><span class="comment">// 定义该需要谁的签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgSetName)</span></span> GetSigners() []sdk.AccAddress &#123;</span><br><span class="line">	<span class="keyword">return</span> []sdk.AccAddress&#123;msg.Owner&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GetSigners</code>定义一个<code>Tx</code>上需要哪些人的签名才能使其有效。<br />
在这种情形下，MsgSetName要求域名所有者在尝试重置域名解析值时要对该交易签名。</p>
<h1>handlerMsgSetName:</h1>
<p>目前MsgSetName已经规定好了, 当接收到了消息后Handler负责定义接下来的行动.<br />
<code>NewHandler本质</code>上是一个<strong>子路由器</strong>，它将进入该模块的消息分配给适当的处理程序。<br />
目前，只有一个<code>Msg/Handler</code>.</p>
<blockquote>
<p>注意：SDK中handler的命名规范是<code>handlerMsg&#123;.Action&#125;</code></p>
<p>需要修改<code>x/cosmosnameservice/handlerMsgSetName.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cosmosnameservice</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/keeper&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle a message to set name</span></span><br><span class="line"><span class="comment">// 接受到msg， 进一步的处理，相当于controller层， 操作keeper层</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMsgSetName</span><span class="params">(ctx sdk.Context, keeper keeper.Keeper, msg types.MsgSetName)</span></span> (*sdk.Result, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 检查MsgSetName的提供者是否为想要设置域名的域名拥有者， 即验证身份</span></span><br><span class="line">	<span class="keyword">if</span> !msg.Owner.Equals(keeper.GetWhoisOwner(ctx, msg.Name)) &#123; <span class="comment">// Checks if the the msg sender is the same as the current owner</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrUnauthorized, <span class="string">&quot;Incorrect Owner&quot;</span>) <span class="comment">// If not, throw an error</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果是本人的话设置所规定的值</span></span><br><span class="line">	<span class="comment">// 调用keeper进行域名的解析值设定</span></span><br><span class="line">	keeper.SetName(ctx, msg.Name, msg.Value) <span class="comment">// If so, set the name to the value specified in the msg.</span></span><br><span class="line">	<span class="keyword">return</span> &amp;sdk.Result&#123;&#125;, <span class="literal">nil</span>                <span class="comment">// return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>handler.go</code>是各个<code>handlerxxxx.go</code>的<strong>总路由</strong>, 所以每一个对应的<code>msg</code>都需要在这里注册, 下面是修改完整的<code>handler.go</code>:</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/handler.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cosmosnameservice</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/keeper&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHandler returns a handler for &quot;nameservice&quot; type messages.</span></span><br><span class="line"><span class="comment">// 返回一个操作nameservice各类消息的Handler对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHandler</span><span class="params">(keeper keeper.Keeper)</span></span> sdk.Handler &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx sdk.Context, msg sdk.Msg)</span></span> (*sdk.Result, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="comment">//.(type)获取接口实例实际的类型指针, 以此调用实例所有可调用的方法，包括接口方法及自有方法。</span></span><br><span class="line">		<span class="comment">//需要注意的是该写法必须与switch case联合使用，case中列出实现该接口的类型。</span></span><br><span class="line">		<span class="keyword">switch</span> msg := msg.(<span class="keyword">type</span>) &#123;</span><br><span class="line">		<span class="comment">// 添加操作类型</span></span><br><span class="line">		<span class="keyword">case</span> types.MsgSetName:</span><br><span class="line">			<span class="keyword">return</span> handleMsgSetName(ctx, keeper, msg)</span><br><span class="line">		<span class="keyword">case</span> types.MsgBuyName:</span><br><span class="line">			<span class="keyword">return</span> handleMsgBuyName(ctx, keeper, msg)</span><br><span class="line">		<span class="keyword">case</span> types.MsgDeleteName:</span><br><span class="line">			<span class="keyword">return</span> handleMsgDeleteName(ctx, keeper, msg)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, fmt.Sprintf(<span class="string">&quot;Unrecognized nameservice Msg type: %v&quot;</span>, msg.Type()))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>现在, 拥有者可以设置域名的解析了, 但是如果是一个域名不存在拥有者的情况呢?<br />
现在模块需要提供一个途径让用户去购买域名, 下面就定义<code>BuyName</code>的Msg</p>
</blockquote>
<h1>MsgBuyName:</h1>
<blockquote>
<p>需要修改<code>./x/cosmosnameservice/types/MsgBuyName.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Originally, this file was named MsgCreateWhois, and has been modified using search-and-replace to our Msg needs.</span></span><br><span class="line"><span class="comment">// 根据MsgCreateWhois文件改写</span></span><br><span class="line"><span class="comment">// MsgBuyName defines the BuyName message</span></span><br><span class="line"><span class="keyword">type</span> MsgBuyName <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="type">string</span>         <span class="string">`json:&quot;name&quot;`</span>  <span class="comment">// 想购买的域名</span></span><br><span class="line">	Bid   sdk.Coins      <span class="string">`json:&quot;bid&quot;`</span>   <span class="comment">// 出价</span></span><br><span class="line">	Buyer sdk.AccAddress <span class="string">`json:&quot;buyer&quot;`</span> <span class="comment">// 购买者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewMsgBuyName is the constructor function for MsgBuyName</span></span><br><span class="line"><span class="comment">// MsgBuyName构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMsgBuyName</span><span class="params">(name <span class="type">string</span>, bid sdk.Coins, buyer sdk.AccAddress)</span></span> MsgBuyName &#123;</span><br><span class="line">	<span class="keyword">return</span> MsgBuyName&#123;</span><br><span class="line">		Name:  name,</span><br><span class="line">		Bid:   bid,</span><br><span class="line">		Buyer: buyer,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route should return the name of the module</span></span><br><span class="line"><span class="comment">// 路由返回模块名nameService</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgBuyName)</span></span> Route() <span class="type">string</span> &#123; <span class="keyword">return</span> RouterKey &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Type should return the action</span></span><br><span class="line"><span class="comment">// 操作类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgBuyName)</span></span> Type() <span class="type">string</span> &#123; <span class="keyword">return</span> <span class="string">&quot;buy_name&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ValidateBasic runs stateless checks on the message</span></span><br><span class="line"><span class="comment">// 基本的检查</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgBuyName)</span></span> ValidateBasic() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> msg.Buyer.Empty() &#123;</span><br><span class="line">		<span class="keyword">return</span> sdkerrors.Wrap(sdkerrors.ErrInvalidAddress, msg.Buyer.String())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(msg.Name) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, <span class="string">&quot;Name cannot be empty&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !msg.Bid.IsAllPositive() &#123;</span><br><span class="line">		<span class="keyword">return</span> sdkerrors.ErrInsufficientFunds</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetSignBytes encodes the message for signing</span></span><br><span class="line"><span class="comment">// 返回消息的编码后格式[]byte</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgBuyName)</span></span> GetSignBytes() []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> sdk.MustSortJSON(ModuleCdc.MustMarshalJSON(msg))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetSigners defines whose signature is required</span></span><br><span class="line"><span class="comment">// 要求签名的对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msg MsgBuyName)</span></span> GetSigners() []sdk.AccAddress &#123;</span><br><span class="line">	<span class="keyword">return</span> []sdk.AccAddress&#123;msg.Buyer&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>handlerMsgBuyName:</h1>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cosmosnameservice</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line"></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/keeper&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle a message to buy name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMsgBuyName</span><span class="params">(ctx sdk.Context, k keeper.Keeper, msg types.MsgBuyName)</span></span> (*sdk.Result, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// Checks if the the bid price is greater than the price paid by the current owner</span></span><br><span class="line">	<span class="comment">// 1.检查当前出价是否高于目前的价格, 注意Msg本身的检查只是简单的检查，这里需要额外数据的检查就只能在Handler中做</span></span><br><span class="line">	<span class="comment">// GetPrice返回coin类型对象，其IsAllGT函数是比较大小（逐个字母比较，全部大于返回true）</span></span><br><span class="line">	<span class="comment">// 当需要的价格 &gt; bid那么就返回错误</span></span><br><span class="line">	<span class="keyword">if</span> k.GetPrice(ctx, msg.Name).IsAllGT(msg.Bid) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrInsufficientFunds, <span class="string">&quot;Bid not high enough&quot;</span>) <span class="comment">// If not, throw an error</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 2.检查当前域名是否已经有拥有者了</span></span><br><span class="line">	<span class="comment">// 不论是已拥有或者没有人拥有， 如果购买者支付出价出现错误，那么都会造成资金的回滚</span></span><br><span class="line">	<span class="keyword">if</span> k.HasCreator(ctx, msg.Name) &#123;</span><br><span class="line">		<span class="comment">// 如果已经是别人拥有的，那么购买者支付对应的出价给域名原来的拥有者</span></span><br><span class="line">		<span class="comment">// coin转移方向： msg.Buyer =&gt; Creator</span></span><br><span class="line">		<span class="comment">// 金额： Bid</span></span><br><span class="line">		err := k.CoinKeeper.SendCoins(ctx, msg.Buyer, k.GetCreator(ctx, msg.Name), msg.Bid)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 如果没有，那么从购买者处减去出价金额, 发送给一个不可回收的地址（burns）</span></span><br><span class="line">		_, err := k.CoinKeeper.SubtractCoins(ctx, msg.Buyer, msg.Bid) <span class="comment">// If so, deduct the Bid amount from the sender</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 分别为域名设置新的所有者与金额</span></span><br><span class="line">	k.SetCreator(ctx, msg.Name, msg.Buyer)</span><br><span class="line">	k.SetPrice(ctx, msg.Name, msg.Bid)</span><br><span class="line">	<span class="keyword">return</span> &amp;sdk.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同上,继续编写类似的<code>MsgDeleteName</code>和<code>handlerMsgDeleteName</code>。</p>
<blockquote>
<p>现在已经有了<code>Msgs</code>和<code>Handlers</code>定义，是时候学习如何使交易中的数据能被查询到！</p>
</blockquote>
<h1>Querier:</h1>
<p>首先创建<code>./x/cosmosnameservice/keeper/querier.go</code>文件。在这里定义应用程序用户可以对那些状态进行查询。<br />
你的<code>nameservice</code>模块会暴露3个<code>querier</code>:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>resolve</code>: 解析值</p>
</li>
<li class="lvl-2">
<p><code>getWhois</code>: 查询域名的所有相关信息</p>
</li>
<li class="lvl-2">
<p><code>listWhois</code>: 查询所有的已存在域名</p>
</li>
</ul>
<p>首先定义<code>NewQuerier</code>函数，该函数充当查询此模块的子路由器（类似于<code>NewHandler</code>函数）。<br />
请注意，因为querier没有类似于Msg的接口，所以需要手动定义switch语句（它们无法从<code>query.Route()</code>函数中删除）：</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/keeper/querier.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> keeper</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">	<span class="comment">// this line is used by starport scaffolding # 1</span></span><br><span class="line">	abci <span class="string">&quot;github.com/tendermint/tendermint/abci/types&quot;</span></span><br><span class="line"></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	sdkerrors <span class="string">&quot;github.com/cosmos/cosmos-sdk/types/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewQuerier creates a new querier for nameservice clients.</span></span><br><span class="line"><span class="comment">// 创建了一个keeper层的查询对象给客户端</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQuerier</span><span class="params">(k Keeper)</span></span> sdk.Querier &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx sdk.Context, path []<span class="type">string</span>, req abci.RequestQuery)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> path[<span class="number">0</span>] &#123; <span class="comment">// 根据客户端输入的路径的第一个变量，确定查询的类型</span></span><br><span class="line">		<span class="comment">// this line is used by starport scaffolding # 2</span></span><br><span class="line">		<span class="comment">// 客户端输入的内容在types/querier.go中定义了常量作为路由</span></span><br><span class="line">		<span class="keyword">case</span> types.QueryResolveName:</span><br><span class="line">			<span class="keyword">return</span> resolveName(ctx, path[<span class="number">1</span>:], k)</span><br><span class="line">		<span class="keyword">case</span> types.QueryListWhois:</span><br><span class="line">			<span class="keyword">return</span> listWhois(ctx, k)</span><br><span class="line">		<span class="keyword">case</span> types.QueryGetWhois:</span><br><span class="line">			<span class="keyword">return</span> getWhois(ctx, path[<span class="number">1</span>:], k)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, <span class="string">&quot;unknown nameservice query endpoint&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在已定义路由器，为每个查询定义输入和响应：</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/types/whois.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Functions used by querier  为用户查询的函数</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询whois的集合</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listWhois</span><span class="params">(ctx sdk.Context, k Keeper)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> whoisList []types.Whois</span><br><span class="line">	store := ctx.KVStore(k.storeKey)</span><br><span class="line">	<span class="comment">// 根据前缀创建循环迭代器, 遍历所有包含此前缀字段的key对应的value</span></span><br><span class="line">	<span class="comment">// KVStorePrefixIterator 按升序迭代所有带有特定前缀的键</span></span><br><span class="line">	iterator := sdk.KVStorePrefixIterator(store, []<span class="type">byte</span>(types.WhoisPrefix))</span><br><span class="line">	<span class="comment">// 遍历</span></span><br><span class="line">	<span class="keyword">for</span> ; iterator.Valid(); iterator.Next() &#123;</span><br><span class="line">		<span class="keyword">var</span> whois types.Whois</span><br><span class="line">		<span class="comment">// 1. 迭代器获取包含特定前缀的完整key</span></span><br><span class="line">		<span class="comment">// 2. 获取whois（[]byte）进行解码</span></span><br><span class="line">		<span class="comment">// 3. 赋值给whois</span></span><br><span class="line">		k.cdc.MustUnmarshalBinaryLengthPrefixed(store.Get(iterator.Key()), &amp;whois)</span><br><span class="line">		<span class="comment">// 添加到集合中</span></span><br><span class="line">		whoisList = <span class="built_in">append</span>(whoisList, whois)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 再将整个list解码/序列化成字节数组，</span></span><br><span class="line">	<span class="comment">// MustMarshalJSONIndent有Must代表不返回其错误直接Panic处理， 即使有err的话，没有的话返回可能的错误</span></span><br><span class="line">	res := codec.MustMarshalJSONIndent(k.cdc, whoisList)</span><br><span class="line">	<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolves a name, returns the value</span></span><br><span class="line"><span class="comment">// 解析域名对应的值,也就是whois中的字段value</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolveName</span><span class="params">(ctx sdk.Context, path []<span class="type">string</span>, keeper Keeper)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 直接调用keeper的解析函数(见下方), key是path[0]</span></span><br><span class="line">	value := keeper.ResolveName(ctx, path[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> value == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="type">byte</span>&#123;&#125;, sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, <span class="string">&quot;could not resolve name&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 编码/序列化为字节数组</span></span><br><span class="line">	<span class="comment">// QueryResResolve是types/querier文件下的函数, QueryResResolve就是解析值的一个结构体</span></span><br><span class="line">	<span class="comment">// 因为MarshalJSONIndent解析需要一个结构体， 所以创建了这样的QueryResResolve结构体以赋值</span></span><br><span class="line">	res, err := codec.MarshalJSONIndent(keeper.cdc, types.QueryResResolve&#123;Value: value&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrJSONMarshal, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询单个Whois</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getWhois</span><span class="params">(ctx sdk.Context, path []<span class="type">string</span>, k Keeper)</span></span> (res []<span class="type">byte</span>, sdkError <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 获取key, path的第一个参数(用户命令行输入)</span></span><br><span class="line">	key := path[<span class="number">0</span>]</span><br><span class="line">	<span class="comment">// 调用keeper的基本方法GetWhois(见上方)</span></span><br><span class="line">	whois, err := k.GetWhois(ctx, key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 编码/序列化为字节数组</span></span><br><span class="line">	res, err = codec.MarshalJSONIndent(k.cdc, whois)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, sdkerrors.Wrap(sdkerrors.ErrJSONMarshal, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，你的<code>Keeper</code>的<code>getter</code>和<code>setter</code>被大量使用。<br />
当构建任何其他使用此模块的应用程序时，您可能需要返回并定义更多的<code>getter/setter</code>来访问您需要的状态片段。<br />
按照约定，每个输出类型都应该是<code>JSON marshallable</code>和<code>stringable</code>(实现了Golang fmt接口)。返回的字节应该是输出结果的JSON编码。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>因此，对于<code>resolve</code>的输出类型，我们将解析字符串包装在一个名为<code>QueryResResolve</code>的结构中，该结构既是<code>JSON marshallable</code>的,又有<code>.string()</code>方法。</p>
</li>
<li class="lvl-2">
<p>对于<code>Whois</code>的输出，正常的Whois结构已经是<code>JSON marshallable</code>的，但是我们需要在其上添加一个<code>.string()</code>方法。</p>
</li>
<li class="lvl-2">
<p>对于<code>names</code>查询的输出也是一样的，[]字符串已经是本机可编组的，但是我们想在其上添加一个. string()方法。</p>
</li>
</ul>
<blockquote>
<p>既然你有办法改变和查看模块状态，那么现在是时候完成它了！ 接下来以<code>Amino编码格式</code>注册类型！</p>
</blockquote>
<h1>Codec文件:</h1>
<p>在<code>Amino</code>中注册你的数据类型使得它们能够<code>被编码/解码</code>。<br />
你创建的任何接口和实现接口的任何结构都需要在<code>RegisterCodec</code>函数中声明。<br />
在此模块中，需要注册三个Msg的实现（<code>SetName</code>, <code>BuyName</code> and <code>DeleteName</code>）。</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/types/codec.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// RegisterCodec registers concrete types on codec</span></span><br><span class="line"><span class="comment">// codec上注册具体的类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterCodec</span><span class="params">(cdc *codec.Codec)</span></span> &#123;</span><br><span class="line">	<span class="comment">// this line is used by starport scaffolding # 1</span></span><br><span class="line">	cdc.RegisterConcrete(MsgBuyName&#123;&#125;, <span class="string">&quot;cosmosnameservice/BuyName&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">	cdc.RegisterConcrete(MsgSetName&#123;&#125;, <span class="string">&quot;cosmosnameservice/SetName&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">	cdc.RegisterConcrete(MsgDeleteName&#123;&#125;, <span class="string">&quot;cosmosnameservice/DeleteName&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ModuleCdc defines the module codec</span></span><br><span class="line"><span class="keyword">var</span> ModuleCdc *codec.Codec</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建实例codec</span></span><br><span class="line">	ModuleCdc = codec.New()</span><br><span class="line">	RegisterCodec(ModuleCdc)</span><br><span class="line">	<span class="comment">// Register the go-crypto to the codec</span></span><br><span class="line">	<span class="comment">// 注册加密函数信息</span></span><br><span class="line">	codec.RegisterCrypto(ModuleCdc)</span><br><span class="line">	<span class="comment">// 封装</span></span><br><span class="line">	ModuleCdc.Seal()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Nameservice模块的CLI:</h1>
<p>Cosmos SDK使用<code>cobra</code>库进行CLI交互。该库使每个模块都可以轻松地显示自己的操作命令。<br />
要开始定义用户与模块的CLI交互，请创建以下文件:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>./x/cosmosnameservice/client/cli/queryWhois.go</code></p>
</li>
<li class="lvl-2">
<p><code>./x/cosmosnameservice/client/cli/txWhois.go</code></p>
</li>
</ul>
<h2 id="Queries">Queries:</h2>
<p>实现查询的客户端命令逻辑:</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/cli/queryWhois.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cli</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有的whois</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdListWhois</span><span class="params">(queryRoute <span class="type">string</span>, cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;list-whois&quot;</span>,     <span class="comment">// 使用的命令</span></span><br><span class="line">		Short: <span class="string">&quot;list all whois&quot;</span>, <span class="comment">// 介绍</span></span><br><span class="line">		<span class="comment">// 运行的内容</span></span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s&quot;</span>, queryRoute, types.QueryListWhois), <span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;could not list Whois\n%s\n&quot;</span>, err.Error())</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> out []types.Whois</span><br><span class="line">			<span class="comment">// 解码结果放到out中</span></span><br><span class="line">			cdc.MustUnmarshalJSON(res, &amp;out)</span><br><span class="line">			<span class="keyword">return</span> cliCtx.PrintOutput(out)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一个whois</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdGetWhois</span><span class="params">(queryRoute <span class="type">string</span>, cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;get-whois [key]&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;Query a whois by key&quot;</span>,</span><br><span class="line">		Args:  cobra.ExactArgs(<span class="number">1</span>), <span class="comment">// 参数对应key</span></span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			key := args[<span class="number">0</span>] <span class="comment">// 获取命令中的key</span></span><br><span class="line">			res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s/%s&quot;</span>, queryRoute, types.QueryGetWhois, key), <span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;could not resolve whois %s \n%s\n&quot;</span>, key, err.Error())</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> out types.Whois</span><br><span class="line">			cdc.MustUnmarshalJSON(res, &amp;out)</span><br><span class="line">			<span class="keyword">return</span> cliCtx.PrintOutput(out)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCmdResolveName queries information about a name</span></span><br><span class="line"><span class="comment">// 查询域名的解析值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdResolveName</span><span class="params">(queryRoute <span class="type">string</span>, cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;resolve [name]&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;resolve name&quot;</span>,</span><br><span class="line">		Args:  cobra.ExactArgs(<span class="number">1</span>),</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			name := args[<span class="number">0</span>]</span><br><span class="line">			res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s/%s&quot;</span>, queryRoute, types.QueryResolveName, name), <span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;could not resolve name - %s \n&quot;</span>, name)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> out types.QueryResResolve</span><br><span class="line">			cdc.MustUnmarshalJSON(res, &amp;out)</span><br><span class="line">			<span class="keyword">return</span> cliCtx.PrintOutput(out)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意上述代码中：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>CLI 引入了一个新的<code>context:CLIContext</code>。它包含有关CLI交互所需的用户输入和应用程序配置的数据。</p>
</li>
<li class="lvl-2">
<p><code>cliCtx.QueryWithData()</code>函数所需的<code>path</code>直接从你的查询路径中映射。</p>
<ul class="lvl-2">
<li class="lvl-6">路径的第一部分用于区分 SDK 应用程序可能的querier类型：custom用于Querier。</li>
<li class="lvl-6">第二部分（<code>nameservice</code>）是将查询路由到的模块的名称。</li>
<li class="lvl-6">最后是要调用模块中的特定的<code>querier</code>。</li>
<li class="lvl-6">在这个例子中，第四部分是查询。这是因为查询参数是一个简单的字符串。要启用更复杂的查询输入，你需要使用<code>.QueryWithData()</code>函数的第二个参数来传入<code>data</code>。</li>
</ul>
</li>
</ul>
<p>继续在<code>cli/query.go</code>中添加子命令:</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/cli/query.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cli</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="comment">// &quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/flags&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// &quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">	<span class="comment">// sdk &quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetQueryCmd returns the cli query commands for this module</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetQueryCmd</span><span class="params">(queryRoute <span class="type">string</span>, cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="comment">// Group nameservice queries under a subcommand</span></span><br><span class="line">	nameserviceQueryCmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use:                        types.ModuleName,</span><br><span class="line">		Short:                      fmt.Sprintf(<span class="string">&quot;Querying commands for the %s module&quot;</span>, types.ModuleName),</span><br><span class="line">		DisableFlagParsing:         <span class="literal">true</span>,</span><br><span class="line">		SuggestionsMinimumDistance: <span class="number">2</span>,</span><br><span class="line">		RunE:                       client.ValidateCmd,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nameserviceQueryCmd.AddCommand(</span><br><span class="line">		flags.GetCommands(</span><br><span class="line">			<span class="comment">// this line is used by starport scaffolding # 1</span></span><br><span class="line">			GetCmdListWhois(queryRoute, cdc),</span><br><span class="line">			GetCmdGetWhois(queryRoute, cdc),</span><br><span class="line">			<span class="comment">// 注意一定添加这个命令, 不然的话使用命令行测试时resolve命令无法解析!!!</span></span><br><span class="line">			GetCmdResolveName(queryRoute, cdc),</span><br><span class="line">		)...,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> nameserviceQueryCmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Transaction">Transaction:</h2>
<p>接下来实现交易命令的客户端。</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/cli/txWhois.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cli</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/x/auth&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/x/auth/client/utils&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 购买新域名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdBuyName</span><span class="params">(cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;buy-name [name] [price]&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;Buys a new name&quot;</span>,</span><br><span class="line">		Args:  cobra.ExactArgs(<span class="number">2</span>),</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			argsName := <span class="type">string</span>(args[<span class="number">0</span>]) <span class="comment">//获取购买的名字name</span></span><br><span class="line"></span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			<span class="comment">// 获取标准读入</span></span><br><span class="line">			inBuf := bufio.NewReader(cmd.InOrStdin())</span><br><span class="line">			<span class="comment">// 创建交易创建器</span></span><br><span class="line">			txBldr := auth.NewTxBuilderFromCLI(inBuf).WithTxEncoder(utils.GetTxEncoder(cdc))</span><br><span class="line"></span><br><span class="line">			coins, err := sdk.ParseCoins(args[<span class="number">1</span>]) <span class="comment">//解析出价</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 构建NewMsgBuyName实例</span></span><br><span class="line">			msg := types.NewMsgBuyName(argsName, coins, cliCtx.GetFromAddress())</span><br><span class="line">			<span class="comment">// 做基本的验证</span></span><br><span class="line">			err = msg.ValidateBasic()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 生成或广播交易</span></span><br><span class="line">			<span class="keyword">return</span> utils.GenerateOrBroadcastMsgs(cliCtx, txBldr, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置域名解析</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdSetWhois</span><span class="params">(cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;set-name [value] [name]&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;Set a new name&quot;</span>,</span><br><span class="line">		Args:  cobra.ExactArgs(<span class="number">2</span>),</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			argsValue := args[<span class="number">0</span>]</span><br><span class="line">			argsName := args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			inBuf := bufio.NewReader(cmd.InOrStdin())</span><br><span class="line">			txBldr := auth.NewTxBuilderFromCLI(inBuf).WithTxEncoder(utils.GetTxEncoder(cdc))</span><br><span class="line">			msg := types.NewMsgSetName(argsName, argsValue, cliCtx.GetFromAddress())</span><br><span class="line">			err := msg.ValidateBasic()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> utils.GenerateOrBroadcastMsgs(cliCtx, txBldr, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除一个域名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCmdDeleteWhois</span><span class="params">(cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;cobra.Command&#123;</span><br><span class="line">		Use:   <span class="string">&quot;delete-name [id]&quot;</span>,</span><br><span class="line">		Short: <span class="string">&quot;Delete a new name by ID&quot;</span>,</span><br><span class="line">		Args:  cobra.ExactArgs(<span class="number">1</span>),</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">			cliCtx := context.NewCLIContext().WithCodec(cdc)</span><br><span class="line">			inBuf := bufio.NewReader(cmd.InOrStdin())</span><br><span class="line">			txBldr := auth.NewTxBuilderFromCLI(inBuf).WithTxEncoder(utils.GetTxEncoder(cdc))</span><br><span class="line"></span><br><span class="line">			msg := types.NewMsgDeleteName(args[<span class="number">0</span>], cliCtx.GetFromAddress())</span><br><span class="line">			err := msg.ValidateBasic()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> utils.GenerateOrBroadcastMsgs(cliCtx, txBldr, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/cli/tx.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cli</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/flags&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/codec&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetTxCmd returns the transaction commands for this module</span></span><br><span class="line"><span class="comment">// 返回模块的交易命令</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTxCmd</span><span class="params">(cdc *codec.Codec)</span></span> *cobra.Command &#123;</span><br><span class="line">	nameserviceTxCmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use:                        types.ModuleName,</span><br><span class="line">		Short:                      fmt.Sprintf(<span class="string">&quot;%s transactions subcommands&quot;</span>, types.ModuleName),</span><br><span class="line">		DisableFlagParsing:         <span class="literal">true</span>,</span><br><span class="line">		SuggestionsMinimumDistance: <span class="number">2</span>,</span><br><span class="line">		RunE:                       client.ValidateCmd,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把txWhois.go中的命令都添加</span></span><br><span class="line">	nameserviceTxCmd.AddCommand(flags.PostCommands(</span><br><span class="line">		<span class="comment">// this line is used by starport scaffolding</span></span><br><span class="line">		GetCmdBuyName(cdc),</span><br><span class="line">		GetCmdSetWhois(cdc),</span><br><span class="line">		GetCmdDeleteWhois(cdc),</span><br><span class="line">	)...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nameserviceTxCmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意在上述代码中：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>使用了<code>authcmd</code>包,它提供对CLI控制的帐户的访问权限，并便于签名。</p>
</li>
</ul>
<h1>NameService模块的REST接口:</h1>
<p>你的模块还可以公开 REST 接口，提供程序访问模块的功能。。首先创建一个文件来保存HTTP的<code>handler</code>：</p>
<h2 id="RegisterRoutes">RegisterRoutes:</h2>
<p>首先在<code>RegisterRoutes</code>函数中为模块定义REST客户端接口。路由都以模块名称开头，以防止命名空间与其他模块的路径冲突：</p>
<blockquote>
<p>需要修改<code>./x/cosmosnameservice/client/rest/rest.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gorilla/mux&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// RegisterRoutes registers nameservice-related REST handlers to a router</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterRoutes</span><span class="params">(cliCtx context.CLIContext, r *mux.Router)</span></span> &#123;</span><br><span class="line">	<span class="comment">// this line is used by starport scaffolding</span></span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois&quot;</span>, buyNameHandler(cliCtx)).Methods(<span class="string">&quot;POST&quot;</span>)</span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois&quot;</span>, listWhoisHandler(cliCtx, <span class="string">&quot;nameservice&quot;</span>)).Methods(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois/&#123;key&#125;&quot;</span>, getWhoisHandler(cliCtx, <span class="string">&quot;nameservice&quot;</span>)).Methods(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois/&#123;key&#125;/resolve&quot;</span>, resolveNameHandler(cliCtx, <span class="string">&quot;nameservice&quot;</span>)).Methods(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois&quot;</span>, setWhoisHandler(cliCtx)).Methods(<span class="string">&quot;PUT&quot;</span>)</span><br><span class="line">	r.HandleFunc(<span class="string">&quot;/nameservice/whois&quot;</span>, deleteWhoisHandler(cliCtx)).Methods(<span class="string">&quot;DELETE&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Query-Handlers">Query Handlers:</h2>
<p>接下来，是时候定义上面提到的处理程序了。这些与前面定义的CLI方法非常相似。</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/rest/queryWhois.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/types/rest&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gorilla/mux&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询所有的whois</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listWhoisHandler</span><span class="params">(cliCtx context.CLIContext, storeName <span class="type">string</span>)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s&quot;</span>, storeName, types.QueryListWhois), <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusNotFound, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		rest.PostProcessResponse(w, cliCtx, res)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一个域名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getWhoisHandler</span><span class="params">(cliCtx context.CLIContext, storeName <span class="type">string</span>)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 获取参数</span></span><br><span class="line">		vars := mux.Vars(r)</span><br><span class="line">		key := vars[<span class="string">&quot;key&quot;</span>]</span><br><span class="line"></span><br><span class="line">		res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s/%s&quot;</span>, storeName, types.QueryGetWhois, key), <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusNotFound, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		rest.PostProcessResponse(w, cliCtx, res)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析域名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolveNameHandler</span><span class="params">(cliCtx context.CLIContext, storeName <span class="type">string</span>)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		vars := mux.Vars(r)</span><br><span class="line">		paramType := vars[<span class="string">&quot;key&quot;</span>]</span><br><span class="line"></span><br><span class="line">		res, _, err := cliCtx.QueryWithData(fmt.Sprintf(<span class="string">&quot;custom/%s/%s/%s&quot;</span>, storeName, types.QueryResolveName, paramType), <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusNotFound, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		rest.PostProcessResponse(w, cliCtx, res)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码要注意：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>我们使用相同的<code>cliCtx.QueryWithData</code>函数来获取数据</p>
</li>
<li class="lvl-2">
<p>这些函数与相应的<code>CLI</code>功能几乎相同</p>
</li>
</ul>
<h2 id="Tx-Handlers">Tx Handlers:</h2>
<p>现在定义 <code>buyName</code> 和 <code>setName</code> 交易路由。<br />
请注意，这些实际上并不能将交易发送进行买入和设置名称。 这需要跟交易请求一起发送发送密码，将是一个安全问题。<br />
相反，这些端点构建并返回每个特定交易，然后可以以安全的方式对其进行签名，然后使用标准端点（如/txs）将其广播到网络。</p>
<blockquote>
<p>需要修改<code>x/cosmosnameservice/client/rest/txWhois.go</code></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/client/context&quot;</span></span><br><span class="line">	sdk <span class="string">&quot;github.com/cosmos/cosmos-sdk/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/types/rest&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/cosmos/cosmos-sdk/x/auth/client/utils&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jerrychan807/cosmos-nameservice/x/cosmosnameservice/types&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> buyNameRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	BaseReq rest.BaseReq <span class="string">`json:&quot;base_req&quot;`</span> <span class="comment">// 包含了创建交易的基本的请求字段</span></span><br><span class="line">	Buyer   <span class="type">string</span>       <span class="string">`json:&quot;buyer&quot;`</span></span><br><span class="line">	Name    <span class="type">string</span>       <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">	Price   <span class="type">string</span>       <span class="string">`json:&quot;price&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 购买域名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buyNameHandler</span><span class="params">(cliCtx context.CLIContext)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> req buyNameRequest</span><br><span class="line">		<span class="comment">// 读取请求</span></span><br><span class="line">		<span class="keyword">if</span> !rest.ReadRESTReq(w, r, cliCtx.Codec, &amp;req) &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, <span class="string">&quot;failed to parse request&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		baseReq := req.BaseReq.Sanitize()</span><br><span class="line">		<span class="comment">// 基本的验证</span></span><br><span class="line">		<span class="keyword">if</span> !baseReq.ValidateBasic(w) &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// AccAddressFromBech32转换string为32位地址的方法</span></span><br><span class="line">		addr, err := sdk.AccAddressFromBech32(req.Buyer)</span><br><span class="line">		fmt.Println(addr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 解析金额</span></span><br><span class="line">		<span class="comment">// ParseCoins 将字符串转为coin</span></span><br><span class="line">		coins, err := sdk.ParseCoins(req.Price)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 创建NewMsgBuyName对象</span></span><br><span class="line">		msg := types.NewMsgBuyName(req.Name, coins, addr)</span><br><span class="line">		<span class="comment">// 简单的验证</span></span><br><span class="line">		err = msg.ValidateBasic()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 返回响应</span></span><br><span class="line">		utils.WriteGenerateStdTxResponse(w, cliCtx, baseReq, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> setWhoisRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	BaseReq rest.BaseReq <span class="string">`json:&quot;base_req&quot;`</span></span><br><span class="line">	Name    <span class="type">string</span>       <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">	Value   <span class="type">string</span>       <span class="string">`json:&quot;value&quot;`</span></span><br><span class="line">	Creator <span class="type">string</span>       <span class="string">`json:&quot;creator&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置解析值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setWhoisHandler</span><span class="params">(cliCtx context.CLIContext)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> req setWhoisRequest</span><br><span class="line">		<span class="keyword">if</span> !rest.ReadRESTReq(w, r, cliCtx.Codec, &amp;req) &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, <span class="string">&quot;failed to parse request&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		baseReq := req.BaseReq.Sanitize()</span><br><span class="line">		<span class="keyword">if</span> !baseReq.ValidateBasic(w) &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		addr, err := sdk.AccAddressFromBech32(req.Creator)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		msg := types.NewMsgSetName(req.Name, req.Value, addr)</span><br><span class="line"></span><br><span class="line">		err = msg.ValidateBasic()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		utils.WriteGenerateStdTxResponse(w, cliCtx, baseReq, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> deleteWhoisRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	BaseReq rest.BaseReq <span class="string">`json:&quot;base_req&quot;`</span></span><br><span class="line">	Owner   <span class="type">string</span>       <span class="string">`json:&quot;owner&quot;`</span></span><br><span class="line">	Name    <span class="type">string</span>       <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除消息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteWhoisHandler</span><span class="params">(cliCtx context.CLIContext)</span></span> http.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> req deleteWhoisRequest</span><br><span class="line">		<span class="keyword">if</span> !rest.ReadRESTReq(w, r, cliCtx.Codec, &amp;req) &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, <span class="string">&quot;failed to parse request&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		baseReq := req.BaseReq.Sanitize()</span><br><span class="line">		<span class="keyword">if</span> !baseReq.ValidateBasic(w) &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		addr, err := sdk.AccAddressFromBech32(req.Owner)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		msg := types.NewMsgDeleteName(req.Name, addr)</span><br><span class="line"></span><br><span class="line">		err = msg.ValidateBasic()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			rest.WriteErrorResponse(w, http.StatusBadRequest, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		utils.WriteGenerateStdTxResponse(w, cliCtx, baseReq, []sdk.Msg&#123;msg&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意上述代码：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>BaseReq</code>包含用于进行交易的基本必填字段（使用哪个密钥，如何解码，使用哪条链等等）并且如所示被设计成嵌入形式。</p>
</li>
<li class="lvl-2">
<p><code>baseReq.ValidateBasic</code>和<code>utils.CompleteAndBroadcastTxREST</code>为你设置响应代码，因此你需担心在使用这些函数时处理错误或成功。</p>
</li>
</ul>
<blockquote>
<p>现在你的模块已经具备了全部功能，需要与 Cosmos SDK 应用合并。</p>
</blockquote>
<h1>AppModule Interface:</h1>
<p>Cosmos SDK为模块提供了一个标准接口。这个<code>AppModule</code>接口要求模块提供一组<code>ModuleBasicsManager</code>使用的方法，以便将它们合并到你的应用程序中。</p>
<blockquote>
<p>相关文件: <code>x/cosmosnameservice/module.go</code></p>
</blockquote>
<h1>Genesis:</h1>
<p><code>AppModule</code>接口包含了许多用于初始化和导出初始化状态的区块链函数。<br />
当启动、停止或导出链时，<code>ModuleBasicManager</code>在每个模块上调用这些函数。下面是一个非常基本的实现，您可以对其进行扩展。<br />
在 <code>x/cosmosnameservice/types/genesis.go</code>。我们会定义初始状态是什么，默认的初始状态以及验证它的方法这样我们就不会遇到任何错误当我们以预先存在的状态开始链的时候。</p>
<blockquote>
<p>相关文件: <code>x/cosmosnameservice/types/genesis.go</code></p>
</blockquote>
<p>关于上述代码的一些注意事项:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>ValidateGenesis()</code>: 验证提供的生成状态，以确保所期望的不变量保持不变</p>
</li>
<li class="lvl-2">
<p><code>DefaultGenesisState()</code>: 主要用于测试。这提供了一个最小的起源状态。</p>
</li>
<li class="lvl-2">
<p>在链启动时调用<code>InitGenesis()</code>，该函数将生成状态导入到keeper中。</p>
</li>
<li class="lvl-2">
<p><code>ExportGenesis()</code>在停止链后被调用，此函数将应用程序状态加载到<code>GenesisState</code>结构中，以便稍后导出到<code>genesis.json</code>以及来自其他模块的数据。</p>
</li>
</ul>
<h1>引入你的模块并完成程序:</h1>
<p>现在你的模块已就绪，它可以和其它两个模块auth和bank被合并到./app.go文件中:</p>
<blockquote>
<p>需要修改<code>app/app.go</code></p>
</blockquote>
<p>接下来，你需要在<code>NewApp</code>结构体中添加存储的<code>key</code>和<code>Keepers</code>：</p>
<h2 id="NewApp结构体">NewApp结构体:</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新的app结构体</span></span><br><span class="line"><span class="keyword">type</span> NewApp <span class="keyword">struct</span> &#123;</span><br><span class="line">	*bam.BaseApp</span><br><span class="line">	cdc *codec.Codec</span><br><span class="line"></span><br><span class="line">	invCheckPeriod <span class="type">uint</span></span><br><span class="line"></span><br><span class="line">	keys  <span class="keyword">map</span>[<span class="type">string</span>]*sdk.KVStoreKey</span><br><span class="line">	tKeys <span class="keyword">map</span>[<span class="type">string</span>]*sdk.TransientStoreKey</span><br><span class="line"></span><br><span class="line">	subspaces <span class="keyword">map</span>[<span class="type">string</span>]params.Subspace</span><br><span class="line"></span><br><span class="line">	accountKeeper     auth.AccountKeeper</span><br><span class="line">	bankKeeper        bank.Keeper</span><br><span class="line">	stakingKeeper     staking.Keeper</span><br><span class="line">	supplyKeeper      supply.Keeper</span><br><span class="line">	paramsKeeper      params.Keeper</span><br><span class="line">	nameserviceKeeper cosmosnameservicekeeper.Keeper</span><br><span class="line">	<span class="comment">// this line is used by starport scaffolding # 3</span></span><br><span class="line">	mm *module.Manager</span><br><span class="line"></span><br><span class="line">	sm *module.SimulationManager</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ simapp.App = (*NewApp)(<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<h2 id="构造函数">构造函数:</h2>
<p>并更新构造函数:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化app</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInitApp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	logger log.Logger, db dbm.DB, traceStore io.Writer, loadLatest <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	invCheckPeriod <span class="type">uint</span>, baseAppOptions ...<span class="keyword">func</span>(*bam.BaseApp)</span></span>,</span><br><span class="line">) *NewApp &#123;</span><br><span class="line">	<span class="comment">// 首先定义将被不同模块共享的编解码器</span></span><br><span class="line">	cdc := MakeCodec()</span><br><span class="line">	<span class="comment">// BaseApp通过ABCI协议处理与Tendermint的交互</span></span><br><span class="line">	bApp := bam.NewBaseApp(appName, logger, db, auth.DefaultTxDecoder(cdc), baseAppOptions...)</span><br><span class="line">	bApp.SetCommitMultiStoreTracer(traceStore)</span><br><span class="line">	bApp.SetAppVersion(version.Version)</span><br><span class="line">	<span class="comment">// 所需要存储的键值</span></span><br><span class="line">	keys := sdk.NewKVStoreKeys(</span><br><span class="line">		bam.MainStoreKey,</span><br><span class="line">		auth.StoreKey,</span><br><span class="line">		staking.StoreKey,</span><br><span class="line">		supply.StoreKey,</span><br><span class="line">		params.StoreKey,</span><br><span class="line">		cosmosnameservicetypes.StoreKey,</span><br><span class="line">		<span class="comment">// this line is used by starport scaffolding # 5</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	tKeys := sdk.NewTransientStoreKeys(staking.TStoreKey, params.TStoreKey)</span><br><span class="line">	<span class="comment">// 初始化一个APP</span></span><br><span class="line">	<span class="keyword">var</span> app = &amp;NewApp&#123;</span><br><span class="line">		BaseApp:        bApp,</span><br><span class="line">		cdc:            cdc,</span><br><span class="line">		invCheckPeriod: invCheckPeriod,</span><br><span class="line">		keys:           keys,</span><br><span class="line">		tKeys:          tKeys,</span><br><span class="line">		subspaces:      <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]params.Subspace),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// paramsKeeper 处理应用程序的参数存储</span></span><br><span class="line">	app.paramsKeeper = params.NewKeeper(app.cdc, keys[params.StoreKey], tKeys[params.TStoreKey])</span><br><span class="line">	app.subspaces[auth.ModuleName] = app.paramsKeeper.Subspace(auth.DefaultParamspace)</span><br><span class="line">	app.subspaces[bank.ModuleName] = app.paramsKeeper.Subspace(bank.DefaultParamspace)</span><br><span class="line">	app.subspaces[staking.ModuleName] = app.paramsKeeper.Subspace(staking.DefaultParamspace)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AccountKeeper 处理address -&gt; account对应关系</span></span><br><span class="line">	app.accountKeeper = auth.NewAccountKeeper(</span><br><span class="line">		app.cdc,</span><br><span class="line">		keys[auth.StoreKey],</span><br><span class="line">		app.subspaces[auth.ModuleName],</span><br><span class="line">		auth.ProtoBaseAccount,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// bankKeeper允许你与sdk.Coins交互</span></span><br><span class="line">	app.bankKeeper = bank.NewBaseKeeper(</span><br><span class="line">		app.accountKeeper,</span><br><span class="line">		app.subspaces[bank.ModuleName],</span><br><span class="line">		app.ModuleAccountAddrs(),</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	app.supplyKeeper = supply.NewKeeper(</span><br><span class="line">		app.cdc,</span><br><span class="line">		keys[supply.StoreKey],</span><br><span class="line">		app.accountKeeper,</span><br><span class="line">		app.bankKeeper,</span><br><span class="line">		maccPerms,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	stakingKeeper := staking.NewKeeper(</span><br><span class="line">		app.cdc,</span><br><span class="line">		keys[staking.StoreKey],</span><br><span class="line">		app.supplyKeeper,</span><br><span class="line">		app.subspaces[staking.ModuleName],</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// 处理Atom</span></span><br><span class="line">	app.stakingKeeper = *stakingKeeper.SetHooks(</span><br><span class="line">		staking.NewMultiStakingHooks(),</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// 与我们自定义的域名服务模块交互</span></span><br><span class="line">	app.nameserviceKeeper = cosmosnameservicekeeper.NewKeeper(</span><br><span class="line">		app.bankKeeper,</span><br><span class="line">		app.cdc,</span><br><span class="line">		keys[cosmosnameservicetypes.StoreKey],</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// this line is used by starport scaffolding # 4</span></span><br><span class="line"></span><br><span class="line">	app.mm = module.NewManager(</span><br><span class="line">		genutil.NewAppModule(app.accountKeeper, app.stakingKeeper, app.BaseApp.DeliverTx),</span><br><span class="line">		auth.NewAppModule(app.accountKeeper),</span><br><span class="line">		bank.NewAppModule(app.bankKeeper, app.accountKeeper),</span><br><span class="line">		supply.NewAppModule(app.supplyKeeper, app.accountKeeper),</span><br><span class="line">		cosmosnameservice.NewAppModule(app.nameserviceKeeper, app.bankKeeper),</span><br><span class="line">		staking.NewAppModule(app.stakingKeeper, app.accountKeeper, app.supplyKeeper),</span><br><span class="line">		<span class="comment">// this line is used by starport scaffolding # 6</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	app.mm.SetOrderEndBlockers(staking.ModuleName)</span><br><span class="line"></span><br><span class="line">	app.mm.SetOrderInitGenesis(</span><br><span class="line">		staking.ModuleName,</span><br><span class="line">		auth.ModuleName,</span><br><span class="line">		bank.ModuleName,</span><br><span class="line">		cosmosnameservicetypes.ModuleName,</span><br><span class="line">		supply.ModuleName,</span><br><span class="line">		genutil.ModuleName,</span><br><span class="line">		<span class="comment">// this line is used by starport scaffolding # 7</span></span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// 注册路由的句柄</span></span><br><span class="line">	<span class="comment">// 注册域名服务路由和查询路由</span></span><br><span class="line">	app.mm.RegisterRoutes(app.Router(), app.QueryRouter())</span><br><span class="line">	<span class="comment">// 初始化相关参数</span></span><br><span class="line">	app.SetInitChainer(app.InitChainer)</span><br><span class="line">	app.SetBeginBlocker(app.BeginBlocker)</span><br><span class="line">	app.SetEndBlocker(app.EndBlocker)</span><br><span class="line">	<span class="comment">// AnteHandler 处理签名验证和交易预处理</span></span><br><span class="line">	app.SetAnteHandler(</span><br><span class="line">		auth.NewAnteHandler(</span><br><span class="line">			app.accountKeeper,</span><br><span class="line">			app.supplyKeeper,</span><br><span class="line">			auth.DefaultSigVerificationGasConsumer,</span><br><span class="line">		),</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// 从KV数据库加载相关数据</span></span><br><span class="line">	app.MountKVStores(keys)</span><br><span class="line">	app.MountTransientStores(tKeys)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> loadLatest &#123;</span><br><span class="line">		err := app.LoadLatestVersion(app.keys[bam.MainStoreKey])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tmos.Exit(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造函数包含以下步骤：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>从每个所需模块中实例化所需的<code>Keeper</code></p>
</li>
<li class="lvl-2">
<p>生成每个<code>Keeper</code>所需的<code>storeKey</code></p>
</li>
<li class="lvl-2">
<p>注册每个模块的<code>handler</code></p>
</li>
<li class="lvl-2">
<p>注册每个模块的<code>querier</code></p>
</li>
<li class="lvl-2">
<p>将<code>KVStores</code>挂载到baseApp的<code>multistore</code>提供的key值</p>
</li>
<li class="lvl-2">
<p>设置<code>initChainer</code>来定义初始应用程序状态</p>
</li>
</ul>
<p>注意模块的启动方式：顺序很重要！在这里，<strong>序列是Auth-&gt; Bank-&gt; Feecollection-&gt; Stake-&gt; Distribution-&gt; Slashing，</strong>，然后为stake模块设置了钩子。这是因为其中一些模块在使用之前就依赖于其他现有模块。</p>
<h2 id="辅助函数">辅助函数:</h2>
<p>添加一个辅助函数来生成一个animo–<code>*codec.Codec</code>，它可以正确地注册你应用程序中使用的所有模块：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个animo： *codec.Codec</span></span><br><span class="line"><span class="comment">// 正确地注册你应用程序中使用的所有模块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCodec</span><span class="params">()</span></span> *codec.Codec &#123;</span><br><span class="line">	<span class="keyword">var</span> cdc = codec.New()</span><br><span class="line"></span><br><span class="line">	ModuleBasics.RegisterCodec(cdc)</span><br><span class="line">	sdk.RegisterCodec(cdc)</span><br><span class="line">	codec.RegisterCrypto(cdc)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cdc.Seal()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>现在您已经创建了一个包含模块的应用程序，现在是时候构建入口点了！</p>
</blockquote>
<h1>程序入口点Entrypoint:</h1>
<p>golang的规范是把编译成可执行程序的文件放在项目的<code>./cmd</code>文件夹中。对于你的应用程序，您要创建2个可执行程序：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>cosmos-nameserviced</code> : 此可执行程序类似于<code>bitcoind</code>或其他加密货币的daemon，因为它维护<strong>p2p连接，广播交易，处理本地存储并提供用以与网络交互的RPC接口</strong>。在这种情况下，Tendermint被用于网络层和排序交易。</p>
</li>
<li class="lvl-2">
<p><code>cosmos-nameservicecli</code> : 此可执行程序提供用户与你的应用程序交互的命令。</p>
</li>
</ul>
<p>相关文件:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>cmd/cosmos-nameserviced/main.go</code></p>
</li>
<li class="lvl-2">
<p><code>cmd/cosmos-nameservicecli/main.go</code></p>
</li>
</ul>
<h2 id="cosmos-nameserviced">cosmos-nameserviced:</h2>
<blockquote>
<p>相关文件:<code>cmd/cosmos-nameserviced/main.go</code></p>
</blockquote>
<p>注意上述代码中：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>上面的大部分代码都结合了来自以下包的CLI命令：</p>
<ol>
<li class="lvl-7">Tendermint</li>
<li class="lvl-7">Cosmos-SDK</li>
<li class="lvl-7">你的nameservice模块</li>
</ol>
</li>
<li class="lvl-2">
<p><code>InitCmd</code>允许应用程序从配置中生成创世纪状态。深入了解函数调用，以了解有关区块链初始化过程的更多信息。</p>
</li>
<li class="lvl-2">
<p><code>AddGenesisAccountCmd</code>可以方便地将帐户添加到创世文件中，允许在区块链启动时就使用资产钱包。</p>
</li>
</ul>
<h2 id="cosmos-nameservicecli">cosmos-nameservicecli:</h2>
<blockquote>
<p>相关文件:<code>cmd/cosmos-nameservicecli/main.go</code></p>
</blockquote>
<p>注意：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>代码结合了来自以下包的CLI命令：Tendermint、Cosmos-SDK、你的nameservice模块</p>
</li>
<li class="lvl-2">
<p>cobra CLI文档将有助于理解上述代码</p>
</li>
<li class="lvl-2">
<p>你可以在这里看到之前定义的<code>ModuleClient</code></p>
</li>
<li class="lvl-2">
<p>注意如何将路由包含在<code>registerRoutes</code>函数中</p>
</li>
</ul>
<blockquote>
<p>现在你已经定义了二进制文件，那么就可以来处理依赖关系管理并构建应用程序。</p>
</blockquote>
<h1>构建你的程序:</h1>
<h2 id="Makefile">Makefile:</h2>
<p>通过在根目录中编写包含常用命令的<code>./Makefile</code>来帮助用户编译应用程序：</p>
<blockquote>
<p>相关文件:<code>./Makefile</code></p>
</blockquote>
<h2 id="go-mod">go.mod:</h2>
<p>Golang有一些依赖管理工具。在本教程中，你将使用Go Modules。Go Modules使用仓库根目录中的<code>go.mod</code>文件来定义应用程序所需的依赖项。Cosmos SDK 应用程序目前依赖于某些库的特定版本。</p>
<h2 id="编译应用程序">编译应用程序:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> PATH=$(go <span class="built_in">env</span> GOPATH)/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install the app into your $GOBIN</span></span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now you should be able to run the following commands:</span></span><br><span class="line"><span class="comment"># 可执行文件会生成在GOPATH的bin目录下</span></span><br><span class="line">cosmos-nameserviced <span class="built_in">help</span></span><br><span class="line">cosmos-nameservicecli <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<h2 id="cosmos-nameserviced-2">cosmos-nameserviced</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameserviced help</span></span><br><span class="line">app Daemon (server)</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  cosmos-nameserviced [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  init                Initialize private validator, p2p, genesis, and application configuration files</span><br><span class="line">  collect-gentxs      Collect genesis txs and output a genesis.json file</span><br><span class="line">  migrate             Migrate genesis to a specified target version</span><br><span class="line">  gentx               Generate a genesis tx carrying a self delegation</span><br><span class="line">  validate-genesis    validates the genesis file at the default location or at the location passed as an arg</span><br><span class="line">  add-genesis-account Add a genesis account to genesis.json</span><br><span class="line">  debug               Tool <span class="keyword">for</span> helping with debugging your application</span><br><span class="line">  start               Run the full node</span><br><span class="line">  unsafe-reset-all    Resets the blockchain database, removes address book files, and resets priv_validator.json to the genesis state</span><br><span class="line"></span><br><span class="line">  tendermint          Tendermint subcommands</span><br><span class="line">  <span class="built_in">export</span>              Export state to JSON</span><br><span class="line"></span><br><span class="line">  version             Print the app version</span><br><span class="line">  <span class="built_in">help</span>                Help about any <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --<span class="built_in">help</span>                    <span class="built_in">help</span> <span class="keyword">for</span> cosmos-nameserviced</span><br><span class="line">      --home string             directory <span class="keyword">for</span> config and data (default <span class="string">&quot;/root/.nameserviced&quot;</span>)</span><br><span class="line">      --inv-check-period uint   Assert registered invariants every N blocks</span><br><span class="line">      --log_level string        Log level (default <span class="string">&quot;main:info,state:info,*:error&quot;</span>)</span><br><span class="line">      --trace                   <span class="built_in">print</span> out full stack trace on errors</span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;cosmos-nameserviced [command] --help&quot;</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<h2 id="cosmos-nameservicecli-2">cosmos-nameservicecli:</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli help</span></span><br><span class="line">Command line interface <span class="keyword">for</span> interacting with cosmosnameserviced</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  cosmos-nameservicecli [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  status      Query remote node <span class="keyword">for</span> status</span><br><span class="line">  config      Create or query an application CLI configuration file</span><br><span class="line">  query       Querying subcommands</span><br><span class="line">  tx          Transactions subcommands</span><br><span class="line"></span><br><span class="line">  rest-server Start LCD (light-client daemon), a <span class="built_in">local</span> REST server</span><br><span class="line"></span><br><span class="line">  keys        Add or view <span class="built_in">local</span> private keys</span><br><span class="line"></span><br><span class="line">  version     Print the app version</span><br><span class="line">  <span class="built_in">help</span>        Help about any <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --chain-id string   Chain ID of tendermint node</span><br><span class="line">  -e, --encoding string   Binary encoding (hex|b64|btc) (default <span class="string">&quot;hex&quot;</span>)</span><br><span class="line">  -h, --<span class="built_in">help</span>              <span class="built_in">help</span> <span class="keyword">for</span> cosmos-nameservicecli</span><br><span class="line">      --home string       directory <span class="keyword">for</span> config and data (default <span class="string">&quot;/root/.nameservicecli&quot;</span>)</span><br><span class="line">  -o, --output string     Output format (text|json) (default <span class="string">&quot;text&quot;</span>)</span><br><span class="line">      --trace             <span class="built_in">print</span> out full stack trace on errors</span><br><span class="line"></span><br><span class="line">Use <span class="string">&quot;cosmos-nameservicecli [command] --help&quot;</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>恭喜，您已完成名称服务应用！尝试运行并使用吧！</p>
</blockquote>
<h1>运行程序:</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化配置文件和创世文件</span></span><br><span class="line">cosmos-nameserviced init moniker --chain-id namechain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个账号,分别为 jack 和 alice</span></span><br><span class="line">cosmos-nameservicecli keys add jack</span><br><span class="line">cosmos-nameservicecli keys add alice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 往 genesis.json 中添加创世账号，账号需要包括地址和初始的币</span></span><br><span class="line">cosmos-nameserviced add-genesis-account $(cosmos-nameservicecli keys show jack -a) 1000nametoken,1000000000stake</span><br><span class="line">cosmos-nameserviced add-genesis-account $(cosmos-nameservicecli keys show alice -a) 1000nametoken,1000000000stake</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查资金余额</span></span><br><span class="line">cosmos-nameservicecli query account $(cosmos-nameservicecli keys show jack -a)</span><br><span class="line">cosmos-nameservicecli query account $(cosmos-nameservicecli keys show alice -a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一笔创世交易, 交易生成在 /config/gentx/filename.json</span></span><br><span class="line">cosmos-nameserviced gentx --name jack</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上一步生成的创世交易写入 genesis.json</span></span><br><span class="line">cosmos-nameserviced collect-gentxs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验 genesis 信息</span></span><br><span class="line">cosmos-nameserviced validate-genesis</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure your CLI to eliminate need for chain-id flag</span></span><br><span class="line">cosmos-nameservicecli config chain-id namechain</span><br><span class="line">cosmos-nameservicecli config output json</span><br><span class="line">cosmos-nameservicecli config indent <span class="literal">true</span></span><br><span class="line">cosmos-nameservicecli config trust-node <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 namachain</span></span><br><span class="line">cosmos-nameserviced start</span><br></pre></td></tr></table></figure>
<p>将看到日志开始不停输出，表示正在生成的区块:</p>
<p><img src="https://raw.githubusercontent.com/jerrychan807/imggg/master/image/20220908145241.png" alt="20220908145241" /></p>
<h1>使用cli测试域名解析应用:</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查资金余额</span></span><br><span class="line">cosmos-nameservicecli query account $(cosmos-nameservicecli keys show jack -a)</span><br><span class="line">cosmos-nameservicecli query account $(cosmos-nameservicecli keys show alice -a)</span><br></pre></td></tr></table></figure>
<h2 id="购买域名">购买域名:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jack 花费 20nametoken 购买 namechain.com</span></span><br><span class="line">cosmos-nameservicecli tx cosmosnameservice buy-name namechain.com 20nametoken --from jack</span><br><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli tx cosmosnameservice buy-name namechain.com 20nametoken --from jack</span></span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;chain_id&quot;</span>: <span class="string">&quot;namechain&quot;</span>,</span><br><span class="line">  <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sequence&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fee&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;amount&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;gas&quot;</span>: <span class="string">&quot;200000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;msgs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;cosmosnameservice/BuyName&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;namechain.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bid&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;denom&quot;</span>: <span class="string">&quot;nametoken&quot;</span>,</span><br><span class="line">            <span class="string">&quot;amount&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;buyer&quot;</span>: <span class="string">&quot;cosmos1vwp2kpjyg7g2x8pd320rugw0m7ut8q3ha9m7u4&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;memo&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">confirm transaction before signing and broadcasting [y/N]: y</span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;height&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;txhash&quot;</span>: <span class="string">&quot;5B8C36D6DCF7334255BD8E974D095389D7BC75577024408F4BB7396B607A84F1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;raw_log&quot;</span>: <span class="string">&quot;[]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="设置域名解析">设置域名解析:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置域名的解析值</span></span><br><span class="line"><span class="comment"># jack 发起一笔交易，给 namechain 设置 DNS 解析为 8.8.8.8</span></span><br><span class="line"><span class="comment"># 注意官方写反了!</span></span><br><span class="line">cosmos-nameservicecli tx cosmosnameservice set-name 8.8.8.8 namechain.com  --from jack</span><br><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli tx cosmosnameservice set-name 8.8.8.8 namechain.com --from jack</span></span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;chain_id&quot;</span>: <span class="string">&quot;namechain&quot;</span>,</span><br><span class="line">  <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sequence&quot;</span>: <span class="string">&quot;4&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fee&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;amount&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;gas&quot;</span>: <span class="string">&quot;200000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;msgs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;cosmosnameservice/SetName&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;namechain.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;cosmos1vwp2kpjyg7g2x8pd320rugw0m7ut8q3ha9m7u4&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;memo&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">confirm transaction before signing and broadcasting [y/N]: y</span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;height&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;txhash&quot;</span>: <span class="string">&quot;B9D2D889371BD86AFCCF5C36A2F3143B0FCCF56A7B0B4BDF247301ABBBFA893B&quot;</span>,</span><br><span class="line">  <span class="string">&quot;raw_log&quot;</span>: <span class="string">&quot;[]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查询域名解析">查询域名解析:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 针对您注册的名称尝试一个resolve查询</span></span><br><span class="line"><span class="comment"># 查询 namechain.com 的信息</span></span><br><span class="line">cosmos-nameservicecli query cosmosnameservice resolve namechain.com</span><br><span class="line"></span><br><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli query cosmosnameservice resolve namechain.com</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;value&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="whois查询">whois查询:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># whois查询</span></span><br><span class="line">cosmos-nameservicecli query cosmosnameservice get-whois namechain.com</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli query cosmosnameservice get-whois namechain.com</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;creator&quot;</span>: <span class="string">&quot;cosmos1vwp2kpjyg7g2x8pd320rugw0m7ut8q3ha9m7u4&quot;</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;value&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;denom&quot;</span>: <span class="string">&quot;nametoken&quot;</span>,</span><br><span class="line">      <span class="string">&quot;amount&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="购买他人的域名">购买他人的域名:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alice买jack的域名</span></span><br><span class="line">cosmos-nameservicecli tx cosmosnameservice buy-name namechain.com 20nametoken --from alice</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli tx cosmosnameservice buy-name namechain.com 20nametoken --from alice</span></span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;chain_id&quot;</span>: <span class="string">&quot;namechain&quot;</span>,</span><br><span class="line">  <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sequence&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fee&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;amount&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;gas&quot;</span>: <span class="string">&quot;200000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;msgs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;cosmosnameservice/BuyName&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;namechain.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bid&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;denom&quot;</span>: <span class="string">&quot;nametoken&quot;</span>,</span><br><span class="line">            <span class="string">&quot;amount&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;buyer&quot;</span>: <span class="string">&quot;cosmos192t6nfdqa9z6n3j8djpyupdzjfdwq6mr9v87vw&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;memo&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">confirm transaction before signing and broadcasting [y/N]: y</span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;height&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;txhash&quot;</span>: <span class="string">&quot;F27BB0F6BA6D861B8C8B6FE48F54CC4D2869E313A8F630B0116C8A227C648A61&quot;</span>,</span><br><span class="line">  <span class="string">&quot;raw_log&quot;</span>: <span class="string">&quot;[]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询域名拥有者</span></span><br><span class="line">cosmos-nameservicecli query cosmosnameservice get-whois namechain.com</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli query cosmosnameservice get-whois namechain.com</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;creator&quot;</span>: <span class="string">&quot;cosmos192t6nfdqa9z6n3j8djpyupdzjfdwq6mr9v87vw&quot;</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;value&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;denom&quot;</span>: <span class="string">&quot;nametoken&quot;</span>,</span><br><span class="line">      <span class="string">&quot;amount&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>creator已由<code>cosmos1vwp2kpjyg7g2x8pd320rugw0m7ut8q3ha9m7u4</code> jack变更为<code>cosmos192t6nfdqa9z6n3j8djpyupdzjfdwq6mr9v87vw</code> alice</p>
<h2 id="删除域名">删除域名:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alice删除域名</span></span><br><span class="line">cosmos-nameservicecli tx cosmosnameservice delete-name namechain.com --from alice</span><br><span class="line"></span><br><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli tx cosmosnameservice delete-name namechain.com --from alice</span></span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;chain_id&quot;</span>: <span class="string">&quot;namechain&quot;</span>,</span><br><span class="line">  <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sequence&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fee&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;amount&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;gas&quot;</span>: <span class="string">&quot;200000&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;msgs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;cosmosnameservice/DeleteName&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;namechain.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;creator&quot;</span>: <span class="string">&quot;cosmos192t6nfdqa9z6n3j8djpyupdzjfdwq6mr9v87vw&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;memo&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">confirm transaction before signing and broadcasting [y/N]: y</span><br><span class="line">Enter keyring passphrase:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;height&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;txhash&quot;</span>: <span class="string">&quot;D168567D166238B1D11B494BFE13CAC317A72E7D0C296EAAB3F96B817159D156&quot;</span>,</span><br><span class="line">  <span class="string">&quot;raw_log&quot;</span>: <span class="string">&quot;[]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询域名拥有者</span></span><br><span class="line">[root@localhost cosmos-nameservice]<span class="comment"># cosmos-nameservicecli query cosmosnameservice get-whois namechain.com</span></span><br><span class="line">could not resolve whois namechain.com</span><br><span class="line">internal</span><br></pre></td></tr></table></figure>
<h2 id="列出所有域名">列出所有域名:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有的nameservice域名</span></span><br><span class="line">cosmos-nameservicecli query cosmosnameservice list-whois</span><br></pre></td></tr></table></figure>
<blockquote>
<p>恭喜，您已经构建了一个Cosmos SDK应用程序！本教程现已完成。接下来是要查看如何使用REST服务器运行相同的命令.</p>
</blockquote>
<blockquote>
<p>rest部分没测,先略过。</p>
</blockquote>
<h1>初始化的配置文件:</h1>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cosmos-nameserviced init &lt;moniker&gt; --chain-id=namechain</span><br></pre></td></tr></table></figure>
<p>初始化配置文件和创世文件,默认目录<code>/root/.nameserviced/config/</code><br />
生成文件结构如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── config</span><br><span class="line">│   ├── app.<span class="property">toml</span></span><br><span class="line">│   ├── config.<span class="property">toml</span></span><br><span class="line">│   ├── genesis.<span class="property">json</span></span><br><span class="line">│   ├── node_key.<span class="property">json</span></span><br><span class="line">│   └── priv_validator_key.<span class="property">json</span></span><br><span class="line">└── data</span><br><span class="line">    └── priv_validator_state.<span class="property">json</span></span><br></pre></td></tr></table></figure>
<h2 id="app-toml">app.toml:</h2>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最小交易gas费用</span></span><br><span class="line">minimum-gas-prices = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># state 存储策略</span></span><br><span class="line">pruning = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These are applied if and only if the pruning strategy is custom.</span></span><br><span class="line">pruning-keep-recent = <span class="string">&quot;0&quot;</span></span><br><span class="line">pruning-keep-every = <span class="string">&quot;0&quot;</span></span><br><span class="line">pruning-interval = <span class="string">&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停的区块高度，用于升级（升级高度）或测试:</span></span><br><span class="line">halt-height = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂停的区块时间，到达该时间时暂停出块，用于升级或测试:</span></span><br><span class="line">halt-time = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 inter-block cache:</span></span><br><span class="line">inter-block-cache = true</span><br></pre></td></tr></table></figure>
<h2 id="config-toml">config.toml:</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ABCI socket 地址:</span></span><br><span class="line">proxy_app = <span class="string">&quot;tcp://127.0.0.1:26658&quot;</span></span><br><span class="line"><span class="comment"># 节点名称:</span></span><br><span class="line">moniker = <span class="string">&quot;moniker&quot;</span></span><br><span class="line"><span class="comment"># 快速同步，允许并发下载区块，同时验证commit</span></span><br><span class="line">fast_sync = <span class="literal">true</span></span><br><span class="line"><span class="comment"># 数据库 (goleveldb | cleveldb | boltdb | rocksdb)</span></span><br><span class="line">db_backend = <span class="string">&quot;goleveldb&quot;</span></span><br><span class="line"><span class="comment"># 数据库存放位置</span></span><br><span class="line">db_dir = <span class="string">&quot;data&quot;</span></span><br><span class="line"><span class="comment"># 日志输出</span></span><br><span class="line">log_level = <span class="string">&quot;main:info,state:info,*:error&quot;</span></span><br><span class="line"><span class="comment"># 日志格式化</span></span><br><span class="line">log_format = <span class="string">&quot;plain&quot;</span></span><br><span class="line"><span class="comment"># 创世文件位置，包含 初始 validator 集合和其他元数据</span></span><br><span class="line">genesis_file = <span class="string">&quot;config/genesis.json&quot;</span></span><br><span class="line"><span class="comment"># validator 私钥文件</span></span><br><span class="line">priv_validator_key_file = <span class="string">&quot;config/priv_validator_key.json&quot;</span></span><br><span class="line"><span class="comment"># 存放 validator 最后的签名状态</span></span><br><span class="line">priv_validator_state_file = <span class="string">&quot;data/priv_validator_state.json&quot;</span></span><br><span class="line"><span class="comment"># Tendermint 监听来自外部 validator 连接进程的地址</span></span><br><span class="line">priv_validator_laddr = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 在 P2P 中进行节点验证的私钥</span></span><br><span class="line">node_key_file = <span class="string">&quot;config/node_key.json&quot;</span></span><br><span class="line"><span class="comment"># abci 连接机制 (socket | grpc)</span></span><br><span class="line">abci = <span class="string">&quot;socket&quot;</span></span><br><span class="line"><span class="comment"># profiling server 监听地址</span></span><br><span class="line">prof_laddr = <span class="string">&quot;localhost:6060&quot;</span></span><br><span class="line"><span class="comment"># 连接新节点时，是否查询 ABCI 应用</span></span><br><span class="line">filter_peers = <span class="literal">false</span></span><br><span class="line"><span class="comment"># RPC server 监听地址</span></span><br><span class="line">laddr = <span class="string">&quot;tcp://127.0.0.1:26657&quot;</span></span><br><span class="line"><span class="comment"># 允许的跨域请求 origins</span></span><br><span class="line">cors_allowed_origins = []</span><br><span class="line"><span class="comment"># 允许的跨域请求方法</span></span><br><span class="line">cors_allowed_methods = [<span class="string">&quot;HEAD&quot;</span>, <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, ]</span><br><span class="line"><span class="comment"># 跨域请求中允许携带的请求头</span></span><br><span class="line">cors_allowed_headers = [<span class="string">&quot;Origin&quot;</span>, <span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>, <span class="string">&quot;X-Server-Time&quot;</span>, ]</span><br><span class="line"><span class="comment"># grpc 监听地址</span></span><br><span class="line">grpc_laddr = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># grpc 最大并发连接数</span></span><br><span class="line">grpc_max_open_connections = 900</span><br><span class="line"><span class="comment"># 是否允许非安全 RPC 命令</span></span><br><span class="line">unsafe=<span class="literal">false</span></span><br><span class="line"><span class="comment"># 最大并发连接数</span></span><br><span class="line">max_open_connections = 900</span><br></pre></td></tr></table></figure>
<h1>项目目录:</h1>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">├── app</span><br><span class="line">│   ├── app.<span class="property">go</span></span><br><span class="line">│   ├── <span class="keyword">export</span>.<span class="property">go</span></span><br><span class="line">│   └── prefix.<span class="property">go</span></span><br><span class="line">├── cmd</span><br><span class="line">│   ├── cosmos-nameservicecli</span><br><span class="line">│   │   └── main.<span class="property">go</span></span><br><span class="line">│   └── cosmos-nameserviced</span><br><span class="line">│       ├── genaccounts.<span class="property">go</span></span><br><span class="line">│       └── main.<span class="property">go</span></span><br><span class="line">├── config.<span class="property">yml</span></span><br><span class="line">├── go.<span class="property">mod</span></span><br><span class="line">├── go.<span class="property">sum</span></span><br><span class="line">├── <span class="title class_">Makefile</span></span><br><span class="line">├── readme.<span class="property">md</span></span><br><span class="line">├── vue <span class="comment">// </span></span><br><span class="line">└── x</span><br><span class="line">    └── cosmosnameservice</span><br><span class="line">        ├── abci.<span class="property">go</span> <span class="comment">// 实现在BeginBlock()和EndBlock()中需要触发的逻辑</span></span><br><span class="line">        ├── client  <span class="comment">// 本模块支持的 命令行方法和REST方法</span></span><br><span class="line">        │   ├── cli</span><br><span class="line">        │   │   ├── query.<span class="property">go</span> <span class="comment">// 从命令行构建本模块支持的 查询请求</span></span><br><span class="line">        │   │   ├── queryWhois.<span class="property">go</span></span><br><span class="line">        │   │   ├── tx.<span class="property">go</span> <span class="comment">// 从命令行构建本模块支持的 交易请求</span></span><br><span class="line">        │   │   └── txWhois.<span class="property">go</span></span><br><span class="line">        │   └── rest</span><br><span class="line">        │       ├── queryWhois.<span class="property">go</span> <span class="comment">// 本模块支持的REST查询请求</span></span><br><span class="line">        │       ├── rest.<span class="property">go</span></span><br><span class="line">        │       └── txWhois.<span class="property">go</span> <span class="comment">// 本模块支持的REST交易</span></span><br><span class="line">        ├── genesis.<span class="property">go</span> <span class="comment">// 导入模块的初始状态以及导出模块的状态</span></span><br><span class="line">        ├── handler.<span class="property">go</span> <span class="comment">// 处理本模块支持的所有类型的消息</span></span><br><span class="line">        ├── handlerMsgBuyName.<span class="property">go</span></span><br><span class="line">        ├── handlerMsgDeleteName.<span class="property">go</span></span><br><span class="line">        ├── handlerMsgSetName.<span class="property">go</span></span><br><span class="line">        ├── keeper <span class="comment">// 本模块的子存储空间的读写功能</span></span><br><span class="line">        │   ├── keeper.<span class="property">go</span></span><br><span class="line">        │   ├── params.<span class="property">go</span></span><br><span class="line">        │   ├── querier.<span class="property">go</span> <span class="comment">// 本模块的子存储空间的查询</span></span><br><span class="line">        │   └── whois.<span class="property">go</span></span><br><span class="line">        ├── <span class="variable language_">module</span>.<span class="property">go</span> <span class="comment">// 实现APPModule接口</span></span><br><span class="line">        ├── spec  <span class="comment">// 模块的规范性说明文档</span></span><br><span class="line">        │   └── <span class="variable constant_">README</span>.<span class="property">md</span></span><br><span class="line">        └── types</span><br><span class="line">            ├── codec.<span class="property">go</span> <span class="comment">// 使用Amino进行序列化的数据类型</span></span><br><span class="line">            ├── errors.<span class="property">go</span> <span class="comment">// 模块执行过程中可能产生的错误</span></span><br><span class="line">            ├── events.<span class="property">go</span> <span class="comment">// 本模块在处理交易或请求时要推送的事件类型</span></span><br><span class="line">            ├── expected_keepers.<span class="property">go</span> <span class="comment">// 本模块以来的其他模块的接口</span></span><br><span class="line">            ├── genesis.<span class="property">go</span> <span class="comment">// 本模块初始化时的相关类型和默认的初始状态</span></span><br><span class="line">            ├── key.<span class="property">go</span> <span class="comment">// 本模块的子存储空间读写时对应的键</span></span><br><span class="line">            ├── <span class="title class_">MsgBuyName</span>.<span class="property">go</span></span><br><span class="line">            ├── <span class="title class_">MsgCreateWhois</span>.<span class="property">go</span></span><br><span class="line">            ├── <span class="title class_">MsgDeleteName</span>.<span class="property">go</span></span><br><span class="line">            ├── <span class="title class_">MsgDeleteWhois</span>.<span class="property">go</span></span><br><span class="line">            ├── msg.<span class="property">go</span> <span class="comment">// 本模块负责处理的消息</span></span><br><span class="line">            ├── <span class="title class_">MsgSetName</span>.<span class="property">go</span></span><br><span class="line">            ├── <span class="title class_">MsgSetWhois</span>.<span class="property">go</span></span><br><span class="line">            ├── params.<span class="property">go</span> <span class="comment">// 本模块的参数配置</span></span><br><span class="line">            ├── querier.<span class="property">go</span> <span class="comment">// 本模块负责处理的查询请求相关类型的定义</span></span><br><span class="line">            ├── types.<span class="property">go</span></span><br><span class="line">            └── <span class="title class_">TypeWhois</span>.<span class="property">go</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>Refs:</h1>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43988498/article/details/114996094">cosmos官方nameservice测试项目详解（代码注释+官方文档错误纠正）</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/cosmos/tutorial/06-set-name.html#msg">Cosmos SDK 中文文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/547fc70b8335">cosmos-sdk-tutorials namechain 体验过程解析</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/cosmos/gravity-bridge/issues/320">panic: crypto/hmac: hash generation function does not produce unique values when using ebdcli keys to add accoun</a> 降级go1.18-&gt;go1.15.15</p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://ldmf.net/archives/78.html">CentOS7 安装 Go 1.18</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yaoqingzhuan/p/10889718.html">linux添加环境变量</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://tutorials.cosmos.network/academy/2-main-concepts/architecture.html">Cosmos开发者门户-宇宙学院-区块链应用架构</a></p>
</li>
</ul>

    </div>

    
    
    
      
  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2022/57333.html" rel="bookmark">StudyRecord-GoBlockchain_Tutorial_Part2_ProofOfWork</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2022/8887.html" rel="bookmark">StudyRecord-GoBlockchain_Tutorial_Part4_Read_Store_and_Manage</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2022/17822.html" rel="bookmark">StudyRecord-以太坊源码分析-EVM对象</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2022/3950.html" rel="bookmark">StudyRecord-以太坊源码分析-EVM解释器对象</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/2022/33963.html" rel="bookmark">StudyRecord-以太坊源码分析-将交易递交给EVM</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/StudyRecord/" rel="tag"># StudyRecord</a>
              <a href="/tags/BlockChain/" rel="tag"># BlockChain</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/59484.html" rel="prev" title="Doc-币安智能链WhitePaper">
      <i class="fa fa-chevron-left"></i> Doc-币安智能链WhitePaper
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/48095.html" rel="next" title="StudyRecord-Bsc详解-bsc_relayer同步区块头">
      StudyRecord-Bsc详解-bsc_relayer同步区块头 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
<script src="https://utteranc.es/client.js"
        repo="jerrychan807/blog-comment"
        issue-term="pathname"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

    

      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">前言:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">开发环境配置:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%97%A7%E7%89%88%E7%9A%84go"><span class="nav-number">2.1.</span> <span class="nav-text">使用旧版的go:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E6%9E%84%E5%BB%BAstarport"><span class="nav-number">2.2.</span> <span class="nav-text">源码构建starport:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="nav-number">2.2.1.</span> <span class="nav-text">下载源码:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDpackr"><span class="nav-number">2.2.2.</span> <span class="nav-text">下载packr:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%8D%E6%AC%A1%E7%BC%96%E8%AF%91"><span class="nav-number">2.2.3.</span> <span class="nav-text">再次编译:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">程序目标:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#State"><span class="nav-number">3.1.</span> <span class="nav-text">State:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Message"><span class="nav-number">3.2.</span> <span class="nav-text">Message:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.</span> <span class="nav-text">交易的处理流程:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text">开始编写你的程序:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">5.</span> <span class="nav-text">类型Types:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">6.</span> <span class="nav-text">Keeper:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Keeper%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.</span> <span class="nav-text">Keeper结构:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Getter-%E5%92%8C-Setter"><span class="nav-number">6.2.</span> <span class="nav-text">Getter 和 Setter:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="nav-number">6.3.</span> <span class="nav-text">其他函数:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">7.</span> <span class="nav-text">Msg 和 Handler:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Msg"><span class="nav-number">7.1.</span> <span class="nav-text">Msg:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Handler"><span class="nav-number">7.2.</span> <span class="nav-text">Handler:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">8.</span> <span class="nav-text">MsgSetName:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Route%E5%92%8CType%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.1.</span> <span class="nav-text">Route和Type接口:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ValidateBasic%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.2.</span> <span class="nav-text">ValidateBasic接口:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GetSignBytes%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.3.</span> <span class="nav-text">GetSignBytes接口:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GetSigners%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.4.</span> <span class="nav-text">GetSigners接口:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">9.</span> <span class="nav-text">handlerMsgSetName:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">10.</span> <span class="nav-text">MsgBuyName:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">11.</span> <span class="nav-text">handlerMsgBuyName:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">12.</span> <span class="nav-text">Querier:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">13.</span> <span class="nav-text">Codec文件:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">14.</span> <span class="nav-text">Nameservice模块的CLI:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Queries"><span class="nav-number">14.1.</span> <span class="nav-text">Queries:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transaction"><span class="nav-number">14.2.</span> <span class="nav-text">Transaction:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">15.</span> <span class="nav-text">NameService模块的REST接口:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RegisterRoutes"><span class="nav-number">15.1.</span> <span class="nav-text">RegisterRoutes:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-Handlers"><span class="nav-number">15.2.</span> <span class="nav-text">Query Handlers:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tx-Handlers"><span class="nav-number">15.3.</span> <span class="nav-text">Tx Handlers:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">16.</span> <span class="nav-text">AppModule Interface:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">17.</span> <span class="nav-text">Genesis:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">18.</span> <span class="nav-text">引入你的模块并完成程序:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NewApp%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">18.1.</span> <span class="nav-text">NewApp结构体:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">18.2.</span> <span class="nav-text">构造函数:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="nav-number">18.3.</span> <span class="nav-text">辅助函数:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">19.</span> <span class="nav-text">程序入口点Entrypoint:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cosmos-nameserviced"><span class="nav-number">19.1.</span> <span class="nav-text">cosmos-nameserviced:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cosmos-nameservicecli"><span class="nav-number">19.2.</span> <span class="nav-text">cosmos-nameservicecli:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">20.</span> <span class="nav-text">构建你的程序:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Makefile"><span class="nav-number">20.1.</span> <span class="nav-text">Makefile:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-mod"><span class="nav-number">20.2.</span> <span class="nav-text">go.mod:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">20.3.</span> <span class="nav-text">编译应用程序:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cosmos-nameserviced-2"><span class="nav-number">20.4.</span> <span class="nav-text">cosmos-nameserviced</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cosmos-nameservicecli-2"><span class="nav-number">20.5.</span> <span class="nav-text">cosmos-nameservicecli:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">21.</span> <span class="nav-text">运行程序:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">22.</span> <span class="nav-text">使用cli测试域名解析应用:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%AD%E4%B9%B0%E5%9F%9F%E5%90%8D"><span class="nav-number">22.1.</span> <span class="nav-text">购买域名:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="nav-number">22.2.</span> <span class="nav-text">设置域名解析:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="nav-number">22.3.</span> <span class="nav-text">查询域名解析:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#whois%E6%9F%A5%E8%AF%A2"><span class="nav-number">22.4.</span> <span class="nav-text">whois查询:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%AD%E4%B9%B0%E4%BB%96%E4%BA%BA%E7%9A%84%E5%9F%9F%E5%90%8D"><span class="nav-number">22.5.</span> <span class="nav-text">购买他人的域名:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%9F%9F%E5%90%8D"><span class="nav-number">22.6.</span> <span class="nav-text">删除域名:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E5%9F%9F%E5%90%8D"><span class="nav-number">22.7.</span> <span class="nav-text">列出所有域名:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">23.</span> <span class="nav-text">初始化的配置文件:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#app-toml"><span class="nav-number">23.1.</span> <span class="nav-text">app.toml:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#config-toml"><span class="nav-number">23.2.</span> <span class="nav-text">config.toml:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">24.</span> <span class="nav-text">项目目录:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">25.</span> <span class="nav-text">Refs:</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Foolisheddy"
      src="https://i.loli.net/2019/04/26/5cc1da1c90e1a.png">
  <p class="site-author-name" itemprop="name">Foolisheddy</p>
  <div class="site-description" itemprop="description">温故而知新</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jerrychan807" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jerrychan807" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:529883409@qq.com" title="E-Mail → mailto:529883409@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Foolisheddy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">879k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">13:19</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
